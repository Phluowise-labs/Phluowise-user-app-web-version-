<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phluowise - Shop Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=verified,flag_2" />
    <link rel="stylesheet" href="css/notifications.css" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#007ACC',
                        tabActive: '#3B74FF',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');

        :root {
            --bg-color: #060606;
            --bg-second: #1D1D1DF2;
            --bg-third: #101010;
            --header-bg: #101010;
            --tab-bg: #101010;
            --btn-color: #007ACC66;
            --btn-border: #3B74FF;
            --text-color: #FFFFFF;
            --bottom-sheet-color: #1D1D1D;
            --input-bg: #292B2F;
            --input-border: #40444B;
            --card-bg-dark: #8080804D;
        }

        body.dark-theme {
            --bg-color: #060606;
            --card-bg-dark: #8080804D;
        }

        body {
            background-color: var(--bg-color);
            color: white;
            font-family: 'Inter', sans-serif;
        }

        /* Material Symbols Styles */
        .material-symbols-outlined {
          font-variation-settings:
          'FILL' 1,
          'wght' 400,
          'GRAD' 0,
          'opsz' 24
        }
        
        .verified-checkmark {
            color: #F19E39;
            font-size: 20px;
            vertical-align: middle;
            margin-left: 4px;
        }

        /* Schedule Pickup Button Mobile Touch Fix */
        .schedule-pickup-btn {
            -webkit-tap-highlight-color: rgba(255, 255, 255, 0.3);
            cursor: pointer;
        }

        .schedule-pickup-btn:active {
            transform: scale(0.98);
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Exact blur styling from React Native BlurView */
        .glass-blur-70 {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background-color: rgba(20, 20, 20, 0.4);
        }

        .glass-blur-50 {
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            background-color: rgba(20, 20, 20, 0.3);
        }

        /* Exact shadow from React Native */
        .rn-shadow {
            box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.25);
        }

        .rn-shadow-lg {
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.3);
        }

        /* Dark mode map styles */
        .leaflet-container {
            background: #1a1a1a !important;
        }

        .leaflet-tile {
            filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7);
        }

        .leaflet-control-zoom a {
            background-color: rgba(30, 30, 30, 0.9) !important;
            border: 1px solid rgba(59, 116, 255, 0.3) !important;
            color: white !important;
        }

        .leaflet-control-zoom a:hover {
            background-color: rgba(59, 116, 255, 0.2) !important;
            border-color: rgba(59, 116, 255, 0.5) !important;
        }

        .leaflet-popup-content-wrapper {
            background: rgba(16, 16, 16, 0.95) !important;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(59, 116, 255, 0.3);
            border-radius: 12px;
            color: white;
        }

        .leaflet-popup-tip {
            background: rgba(16, 16, 16, 0.95) !important;
            border: 1px solid rgba(59, 116, 255, 0.3);
        }

        .custom-marker {
            background: linear-gradient(135deg, #3B74FF, #007ACC);
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(59, 116, 255, 0.4);
        }

        .user-location-marker {
            background: #00ff88;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.4);
        }

        /* Bottom sheet animation classes */
        .bottom-sheet-container {
            background: rgba(29, 29, 31, 0.8);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .bottom-sheet-container.active {
            opacity: 1;
            visibility: visible;
        }

        .bottom-sheet-content {
            background: rgba(29, 29, 31, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 28px 28px 0 0;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.33, 1, 0.68, 1);
            box-shadow: 0 -20px 60px rgba(0, 0, 0, 0.3);
        }

        .bottom-sheet-content.active {
            transform: translateY(0);
        }

        .sheet-drag-handle {
            width: 40px;
            height: 4px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin: 0 auto 16px auto;
        }

        .section-header {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .section-subheader {
            font-size: 18px;
            font-weight: 500;
            color: #9BA1A6;
            margin-bottom: 20px;
        }

        .form-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 20px;
        }

        .form-label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            color: #9BA1A6;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
        }

        .form-input {
            background-color: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: var(--text-color);
            padding: 16px 20px;
            border-radius: 12px;
            width: 100%;
            transition: all 0.2s ease;
            font-size: 18px;
        }

        .form-input:focus {
            outline: none;
            border-color: #3B74FF;
            box-shadow: 0 0 0 3px rgba(59, 116, 255, 0.15);
            background-color: rgba(255, 255, 255, 0.1);
        }

        .form-textarea {
            background-color: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: var(--text-color);
            padding: 16px 20px;
            border-radius: 12px;
            width: 100%;
            transition: all 0.2s ease;
            font-size: 18px;
            resize: vertical;
            min-height: 120px;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #3B74FF;
            box-shadow: 0 0 0 3px rgba(59, 116, 255, 0.15);
            background-color: rgba(255, 255, 255, 0.1);
        }

        .step-content {
            display: block;
        }

        .step-content.hidden {
            display: none;
        }

        .step-indicator-container {
            padding: 8px 0 24px 0;
            margin-bottom: 8px;
            position: relative;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: none;
        }

        .step-indicator-line {
            position: absolute;
            top: 24px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: rgba(255, 255, 255, 0.1);
            z-index: 0;
        }

        .step-indicator-wrapper {
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: space-between;
        }

        .step-indicator-item {
            width: 36px;
            height: 36px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            position: relative;
            border: 2px solid transparent;
        }

        .step-indicator-item.active {
            background-color: #3B74FF;
            color: white;
            border-color: #3B74FF;
            box-shadow: 0 4px 12px rgba(59, 116, 255, 0.3);
        }

        .step-indicator-item.completed {
            background: rgba(16, 185, 129, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            border: 2px solid rgba(16, 185, 129, 0.4);
        }

        .step-indicator-item.default {
            background-color: rgba(255, 255, 255, 0.1);
            color: #9BA1A6;
            border-color: rgba(255, 255, 255, 0.1);
        }

        .step-indicator-name {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 10px;
            color: #9BA1A6;
            font-weight: 500;
        }

        .step-indicator-item.active .step-indicator-name {
            color: #3B74FF;
            font-weight: 600;
        }

        .step-indicator-item.completed .step-indicator-name {
            color: #10B981;
        }

        .terms-radio-container {
            margin-bottom: 24px;
        }

        .terms-radio-item {
            margin-bottom: 16px;
            padding: 16px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .terms-radio-item:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }

        .terms-radio-item.selected {
            border-color: #3B74FF;
            background-color: rgba(59, 116, 255, 0.1);
        }

        .terms-radio-label {
            display: flex;
            align-items: center;
            font-size: 18px;
            color: var(--text-color);
            font-weight: 500;
        }

        .terms-radio-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .terms-radio-item.selected .terms-radio-circle {
            border-color: #3B74FF;
            background-color: #3B74FF;
        }

        .terms-radio-item.selected .terms-radio-circle::after {
            content: '';
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: white;
        }

        .terms-details {
            margin-top: 8px;
            padding-left: 36px;
            font-size: 16px;
            color: #9BA1A6;
        }

        .terms-container {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .recipient-type-container {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .recipient-type-btn {
            flex: 1;
            padding: 20px 12px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            font-weight: 600;
            font-size: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .recipient-type-btn:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }

        .recipient-type-btn.active {
            background-color: rgba(59, 116, 255, 0.15);
            border-color: #3B74FF;
            color: #3B74FF;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            margin-bottom: 20px;
        }

        .toggle-label {
            font-size: 18px;
            color: var(--text-color);
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #3B74FF;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }

        .business-type-container {
            margin-top: 16px;
        }

        .business-name-container {
            margin-top: 16px;
        }

        .business-type-select {
            background-color: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: var(--text-color);
            padding: 16px 20px;
            border-radius: 12px;
            width: 100%;
            font-size: 18px;
            cursor: pointer;
        }

        .business-type-select:focus {
            outline: none;
            border-color: #3B74FF;
            box-shadow: 0 0 0 3px rgba(59, 116, 255, 0.15);
        }

        .saved-recipients-container {
            margin-top: 20px;
        }

        .saved-recipient-item {
            padding: 16px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .saved-recipient-item:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }

        .saved-recipient-item.selected {
            border-color: #3B74FF;
            background-color: rgba(59, 116, 255, 0.1);
        }

        .saved-recipient-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 4px;
        }

        .saved-recipient-info {
            font-size: 16px;
            color: #9BA1A6;
        }

        .delete-recipient-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #EF4444;
            border-radius: 6px;
            padding: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-recipient-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            border-color: rgba(239, 68, 68, 0.5);
        }

        .recipient-content {
            cursor: pointer;
            padding-right: 40px;
        }

        .you-recipient-info {
            background-color: rgba(59, 116, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            border: 1px solid rgba(59, 116, 255, 0.2);
        }

        .you-recipient-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .you-recipient-item:last-child {
            border-bottom: none;
        }

        .you-recipient-label {
            font-size: 16px;
            color: #9BA1A6;
        }

        .you-recipient-value {
            font-size: 16px;
            color: var(--text-color);
            font-weight: 500;
        }

        /* Date and Time Selection */
        .datetime-container {
            margin-top: 20px;
        }

        .datetime-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .datetime-input {
            flex: 1;
        }

        .time-slots-container {
            margin-top: 20px;
        }

        .time-slots-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .time-slot-btn {
            padding: 16px 8px;
            background-color: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--text-color);
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .time-slot-btn:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }

        .time-slot-btn.selected {
            background-color: rgba(59, 116, 255, 0.15);
            border-color: #3B74FF;
            color: #3B74FF;
        }

        .time-slot-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .info-card {
            background: linear-gradient(135deg, rgba(59, 116, 255, 0.1) 0%, rgba(59, 116, 255, 0.05) 100%);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(59, 116, 255, 0.2);
            margin-bottom: 20px;
        }

        .info-title {
            font-size: 20px;
            font-weight: 600;
            color: #3B74FF;
            margin-bottom: 8px;
        }

        .info-text {
            font-size: 16px;
            color: #9BA1A6;
            line-height: 1.5;
        }

        /* Product Selection */
        .service-products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .add-more-btn {
            background-color: rgba(59, 116, 255, 0.1);
            border: 1px solid #3B74FF;
            color: #3B74FF;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-more-btn:hover {
            background-color: rgba(59, 116, 255, 0.2);
            transform: translateY(-1px);
        }

        .selected-products-container {
            margin-top: 24px;
        }

        .selected-product-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .selected-product-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
        }

        .selected-product-details {
            flex: 1;
        }

        .selected-product-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 4px;
        }

        .selected-product-price {
            font-size: 16px;
            color: #9BA1A6;
        }

        .selected-product-quantity {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quantity-btn-small {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: var(--text-color);
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .quantity-display-small {
            font-size: 18px;
            font-weight: 600;
            min-width: 30px;
            text-align: center;
        }

        .delivery-instructions {
            margin-top: 20px;
        }

        .instructions-title {
            font-size: 18px;
            font-weight: 600;
            color: #9BA1A6;
            margin-bottom: 12px;
        }

        .instructions-example {
            font-size: 14px;
            color: #9BA1A6;
            font-style: italic;
            margin-bottom: 12px;
        }

        .delivery-info-note {
            background-color: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
            color: #F59E0B;
            font-size: 16px;
            line-height: 1.5;
        }

        .no-products-selected {
            text-align: center;
            padding: 40px 20px;
            color: #9BA1A6;
            font-size: 18px;
        }

        /* Price Display */
        .price-display {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
        }

        .price-row.total {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 16px;
            margin-top: 8px;
        }

        .price-label {
            font-size: 18px;
            color: #9BA1A6;
        }

        .price-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
        }

        .price-value.total {
            font-size: 24px;
            font-weight: 700;
            color: #3B74FF;
        }

        /* Review Section */
        .review-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .review-section {
            margin-bottom: 20px;
        }

        .review-section:last-child {
            margin-bottom: 0;
        }

        .review-section-title {
            font-size: 18px;
            font-weight: 600;
            color: #9BA1A6;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .review-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .review-item:last-child {
            border-bottom: none;
        }

        .review-label {
            font-size: 18px;
            color: #9BA1A6;
        }

        .review-value {
            font-size: 18px;
            font-weight: 500;
            color: var(--text-color);
        }

        .review-product-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .review-product-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
        }

        .review-product-details {
            flex: 1;
        }

        .review-product-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
        }

        .review-product-price {
            font-size: 16px;
            color: #3B74FF;
            font-weight: 600;
        }

        /* Payment Methods */
        .payment-method-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .payment-method-card:hover {
            transform: translateY(-4px);
            border-color: rgba(59, 116, 255, 0.5);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .payment-method-card.selected {
            border-color: #3B74FF;
            background-color: rgba(59, 116, 255, 0.1);
        }

        .payment-method-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }

        .payment-method-icon.mobile {
            background-color: rgba(34, 197, 94, 0.15);
            color: #10B981;
        }

        .payment-check {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 24px;
            height: 24px;
            border-radius: 12px;
            background: rgba(59, 116, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(59, 116, 255, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .payment-method-card.selected .payment-check {
            opacity: 1;
        }

        .mobile-payment-note {
            background-color: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
            color: #10B981;
            font-size: 16px;
        }

        /* Processing and Success States */
        .processing-spinner {
            width: 80px;
            height: 80px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #3B74FF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 24px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .success-icon {
            width: 80px;
            height: 80px;
            border-radius: 40px;
            background: rgba(16, 185, 129, 0.2);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 2px solid rgba(16, 185, 129, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 24px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3B74FF 0%, #2563EB 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Rating Stars */
        .rating-stars-container {
            display: flex;
            gap: 8px;
            margin: 24px 0;
        }

        .rating-star-large {
            font-size: 36px;
            color: rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .rating-star-large.selected {
            color: #FCD34D;
            transform: scale(1.1);
        }

        .rating-star-large:hover {
            color: #FCD34D;
            transform: scale(1.2);
        }

        /* Navigation Buttons */
        .step-navigation {
            display: flex;
            gap: 12px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .nav-btn {
            flex: 1;
            padding: 20px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 18px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-btn.prev {
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-color);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .nav-btn.prev:hover {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .nav-btn.next {
            background: rgba(59, 116, 255, 0.2);
            color: white;
            border: 1px solid rgba(59, 116, 255, 0.4);
        }

        .nav-btn.next:hover {
            background: rgba(59, 116, 255, 0.3);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 116, 255, 0.3);
        }

        .nav-btn.pay {
            background: rgba(16, 185, 129, 0.2);
            color: white;
            border: 1px solid rgba(16, 185, 129, 0.4);
        }

        .nav-btn.pay:hover {
            background: rgba(16, 185, 129, 0.3);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .nav-btn.done {
            background: rgba(59, 116, 255, 0.2);
            color: white;
            border: 1px solid rgba(59, 116, 255, 0.4);
        }

        .nav-btn.done:hover {
            background: rgba(59, 116, 255, 0.3);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 116, 255, 0.3);
        }

        /* Error and Success Messages */
        .error-message {
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 12px;
            padding: 16px 20px;
            margin-top: 12px;
            color: #EF4444;
            font-size: 16px;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        .success-message {
            background-color: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 12px;
            padding: 16px 20px;
            margin-top: 12px;
            color: #10B981;
            font-size: 16px;
            display: none;
        }

        .success-message.active {
            display: block;
        }

        /* New Product Selection Step Styles */
        .products-grid-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .product-select-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .product-select-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .product-select-card.selected {
            border-color: #3B74FF;
            background-color: rgba(59, 116, 255, 0.1);
        }

        .product-select-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            margin-bottom: 8px;
        }

        .product-select-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 4px;
        }

        .product-select-price {
            font-size: 16px;
            font-weight: 700;
            color: #3B74FF;
        }

        .product-select-quantity {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .quantity-btn-product {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: var(--text-color);
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .quantity-display-product {
            font-size: 16px;
            font-weight: 600;
            min-width: 30px;
            text-align: center;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>

<body class="dark-theme h-screen flex flex-col overflow-hidden">

    <!-- Header with Back Button and Profile Image (Exact from schedule.tsx) -->
    <div class="relative w-full">
        <!-- Banner Background -->
        <div class="absolute inset-0 w-full h-[180px] overflow-hidden">
            <img src="images/main/adsBack.png" class="w-full h-full object-cover" alt="Advertisement Banner">
        </div>
        
        <!-- Back Button -->
        <div class="absolute top-5 left-4 z-20">
            <button onclick="window.history.back()" class="w-10 h-10 flex items-center justify-center">
                <img src="images/main/ArrowLeftIcon.png" class="w-6 h-6 object-contain">
            </button>
        </div>

        <!-- Header Space (height: 80) -->
        <div class="h-[80px] w-full"></div>

        <!-- Profile Image Container (top: 40, left: 40, p: 8, rounded: 14, height: 90, width: 95) -->
        <!-- Increased top margin for spacing -->
        <div class="absolute top-[60px] left-10 z-10 p-2 rounded-[14px]"
            style="background-color: var(--bottom-sheet-color); height: 90px; width: 95px;">
            <div class="w-full h-full rounded-[14px] overflow-hidden">
                <img id="shopProfileImage" src="images/main/ScheduleImage1.png"
                    class="w-full h-full object-cover">
            </div>
        </div>
    </div>

    <!-- Main Scrollable Content -->
    <div class="flex-1 overflow-y-auto hide-scrollbar pb-[70px] mt-2 relative z-0">

        <!-- Top Spacer - Increased to move company data beneath banner -->
        <div class="h-[100px]"></div>

        <div class="px-0 relative flex flex-col">

            <!-- CompanyDescription Component (Exact) -->
            <div class="px-10 p-2 relative">
                <!-- Added spacing before company data -->
                <div class="mb-6">
                    <h1 class="text-white text-2xl font-bold">
                        Voltic Water Company
                        <span class="material-symbols-outlined verified-checkmark">verified</span>
                    </h1>
                    <p class="text-[#808080] text-lg mt-1">Accra, Ghana</p>
                </div>
                
                <div id="descriptionContainer" class="overflow-hidden transition-all duration-300"
                    style="height: 45px;">
                    <div class="relative h-full">
                        <!-- Linear Gradient Overlay (exact from RN) -->
                        <div class="absolute inset-0 pointer-events-none z-10"
                            style="background: linear-gradient(to bottom, transparent, var(--bg-color));"
                            id="descGradient"></div>
                        <p id="descriptionText" class="text-white text-base font-normal leading-6 tracking-tighter text-justify">
                            Voltic Water Company is a leading provider of premium bottled water in Ghana, 
                            offering a wide range of water products including sachets, bottles, and dispensers. 
                            Committed to delivering clean, safe, and refreshing water to homes and businesses 
                            across Accra, we ensure timely delivery and exceptional customer service. 
                            Our state-of-the-art purification process guarantees the highest quality standards 
                            for all our products.
                        </p>
                    </div>
                </div>
                <!-- Read More Button (rounded: 5, shadow, height: 30, width: 60) -->
                <div class="relative pl-0 mt-[-10px] z-20">
                    <button onclick="toggleReadMore()"
                        class="h-[30px] w-[60px] flex items-center justify-center rounded-[5px] rn-shadow"
                        style="background-color: var(--bottom-sheet-color);">
                        <span id="readMoreText" class="text-white font-medium text-sm">more +</span>
                    </button>
                </div>
            </div>

            <!-- WorkingDays Component (Exact) -->
            <div class="mt-4 px-10">
                <div class="flex flex-row items-center gap-2">
                    <span class="text-white text-base font-medium">Working Days</span>
                    <!-- Dropdown (exact zIndex and styling) -->
                    <select id="workingDaysSelect" onchange="updateWorkingHours()"
                        class="bg-[#202225] text-white border-none rounded-xl px-2 py-1 w-[140px] focus:outline-none">
                        <option value="monday">Monday</option>
                        <option value="tuesday">Tuesday</option>
                        <option value="wednesday">Wednesday</option>
                        <option value="thursday">Thursday</option>
                        <option value="friday">Friday</option>
                        <option value="saturday">Saturday</option>
                        <option value="sunday">Sunday</option>
                    </select>
                </div>
                <!-- Time Display Row (exact bg #292B2F, rounded, padding) -->
                <div class="mt-2 w-full flex flex-row items-center justify-center p-1 rounded gap-6"
                    style="background-color: #292B2F;">
                    <div class="flex flex-row justify-between w-[40%] items-center">
                        <span class="text-white text-base font-medium">Opening:</span>
                        <span id="openingTime" class="text-white text-base font-medium">08:00</span>
                    </div>
                    <div class="flex flex-row justify-between w-[40%] items-center">
                        <span class="text-white text-base font-medium">Closing:</span>
                        <span id="closingTime" class="text-white text-base font-medium">17:00</span>
                    </div>
                </div>
            </div>

            <!-- SocialMedia Component (Exact from React Native) -->
            <div class="mt-1">
                <div class="w-full flex flex-row justify-between items-center py-2 px-8" style="gap: 24px; background-color: var(--bottom-sheet-color); height: 42px;">
                    <span class="text-white font-[500] text-lg">Social media</span>
                    <div class="flex flex-row justify-center items-center" style="gap: 8px;">
                        <!-- Facebook -->
                        <div onclick="showSocialModal('Facebook')" class="flex flex-row justify-center items-center p-1 cursor-pointer hover:opacity-80 transition-opacity" style="background-color: #333333; height: 28px; width: 28px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                            </svg>
                        </div>
                        <!-- Instagram -->
                        <div onclick="showSocialModal('Instagram')" class="flex flex-row justify-center items-center p-1 cursor-pointer hover:opacity-80 transition-opacity" style="background-color: #333333; height: 28px; width: 28px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                            </svg>
                        </div>
                        <!-- Twitter -->
                        <div onclick="showSocialModal('Twitter')" class="flex flex-row justify-center items-center p-1 cursor-pointer hover:opacity-80 transition-opacity" style="background-color: #333333; height: 28px; width: 28px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                            </svg>
                        </div>
                        <!-- LinkedIn -->
                        <div onclick="showSocialModal('LinkedIn')" class="flex flex-row justify-center items-center p-1 cursor-pointer hover:opacity-80 transition-opacity" style="background-color: #333333; height: 28px; width: 28px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                            </svg>
                        </div>
                        <!-- Discord -->
                        <div onclick="showSocialModal('Discord')" class="flex flex-row justify-center items-center p-1 cursor-pointer hover:opacity-80 transition-opacity" style="background-color: #333333; height: 28px; width: 28px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-Navigation Tabs (exact height: 35, rounded: 100, px: 24) -->
            <div class="mt-4 pl-6">
                <div class="flex flex-row gap-4 overflow-x-auto hide-scrollbar pb-2">
                    <button onclick="setSubView('schedule')" id="btn-schedule"
                        class="h-[35px] px-6 rounded-[100px] flex items-center justify-center border border-transparent transition-all">
                        <span class="text-white text-xl font-medium capitalize whitespace-nowrap">Schedule Order</span>
                    </button>
                    <button onclick="setSubView('products')" id="btn-products"
                        class="h-[35px] px-6 rounded-[100px] flex items-center justify-center border border-transparent bg-transparent transition-all">
                        <span class="text-white text-xl font-medium capitalize">Products</span>
                    </button>
                    <button onclick="setSubView('rating')" id="btn-rating"
                        class="h-[35px] px-6 rounded-[100px] flex items-center justify-center border border-transparent bg-transparent transition-all">
                        <span class="text-white text-xl font-medium capitalize">Rating</span>
                    </button>
                </div>
            </div>

            <!-- Views Content -->
            <div class="mt-4 pb-[150px]">

                <!-- SCHEDULE ORDER VIEW (ScheduleOrder.tsx - Exact) -->
                <div id="view-schedule" class="block">
                    <!-- Container height: 300 (from RN) - Now with Map -->
                    <div class="relative w-full" style="height: 300px;">
                        <!-- Map Container -->
                        <div id="scheduleMap" class="w-full h-full rounded-lg overflow-hidden">
                            <!-- Map will be initialized here -->
                        </div>

                        <!-- View Company Website Button (width: 225, top: 10, left: 20, rounded: 5, elevation: 5) -->
                        <button
                            class="flex flex-row items-center gap-2 p-3 rounded-[5px] absolute top-[10px] left-[20px] rn-shadow z-[1000]"
                            style="background-color: var(--bottom-sheet-color); width: 225px;">
                            <svg class="w-6 h-6" fill="white" stroke="white" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10" stroke="white" />
                                <path d="M2 12h20" stroke="white" />
                                <path
                                    d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" stroke="white" />
                            </svg>
                            <span class="text-white text-base font-[500] px-4 leading-5 capitalize whitespace-nowrap">View Company Website</span>
                        </button>

                        <!-- Contact Popup (width: 250, rounded: 10, bottom: 70, right: 20) -->
                        <div id="contactPopup" class="absolute bottom-[70px] right-[20px] hidden rounded-[10px] z-[1000]"
                            style="width: 250px; background-color: var(--bottom-sheet-color);">
                            <button class="flex flex-row items-center gap-4 pl-4 w-full" style="height: 60px;">
                                <div class="w-8 h-8 rounded-full border border-white flex items-center justify-center">
                                    <span class="text-white text-xl font-bold">+</span>
                                </div>
                                <span class="text-white text-lg font-[600] capitalize px-4 leading-5 whitespace-nowrap">+234 810 000 0000</span>
                            </button>
                        </div>

                        <!-- Call Button (height: 60, width: 60, rounded: 10, bottom: 5, right: 20, elevation: 5) -->
                        <button onclick="toggleContactPopup()"
                            class="absolute bottom-[5px] right-[20px] rounded-[10px] flex items-center justify-center z-[1000]"
                            style="background-color: var(--bottom-sheet-color); width: 60px; height: 60px; box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.25);">
                            <svg class="w-8 h-8" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                                <path
                                    d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" />
                            </svg>
                        </button>

                        <!-- Map Controls -->
                        <div class="absolute top-[10px] right-[20px] z-[1000] flex flex-col gap-2">
                            <button onclick="toggleMapType()" class="w-10 h-10 bg-[rgba(30,30,30,0.9)] backdrop-blur-lg border border-[rgba(59,116,255,0.3)] rounded-lg flex items-center justify-center text-white hover:bg-[rgba(59,116,255,0.2)] transition-all" title="Toggle Map View">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="3"/>
                                    <path d="M12 1v6m0 6v6m4.22-13.22l4.24 4.24M1.54 1.54l4.24 4.24M20.46 20.46l-4.24-4.24M1.54 20.46l4.24-4.24"/>
                                    <circle cx="12" cy="12" r="8" stroke-dasharray="2 2"/>
                                </svg>
                            </button>
                            <button onclick="zoomInMap()" class="w-10 h-10 bg-[rgba(30,30,30,0.9)] backdrop-blur-lg border border-[rgba(59,116,255,0.3)] rounded-lg flex items-center justify-center text-white hover:bg-[rgba(59,116,255,0.2)] transition-all">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"/>
                                    <path d="M21 21l-4.35-4.35M11 8v6M8 11h6"/>
                                </svg>
                            </button>
                            <button onclick="zoomOutMap()" class="w-10 h-10 bg-[rgba(30,30,30,0.9)] backdrop-blur-lg border border-[rgba(59,116,255,0.3)] rounded-lg flex items-center justify-center text-white hover:bg-[rgba(59,116,255,0.2)] transition-all">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"/>
                                    <path d="M21 21l-4.35-4.35M8 11h6"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Schedule Pickup Button (height: 46, rounded: 30, paddingVertical: 15) -->
                    <div class="px-4 relative py-[15px] flex justify-center">
                        <button id="schedulePickupBtn"
                            class="rounded-[30px] flex items-center justify-center border schedule-pickup-btn"
                            style="background-color: var(--btn-color); border-color: var(--btn-border); height: 46px; width: 242px; touch-action: manipulation;">
                            <span class="text-white text-xl font-[500] capitalize leading-5">Schedule Pickup</span>
                        </button>
                    </div>
                </div>

                <!-- PRODUCTS VIEW (Products.tsx - Exact Grid) -->
                <div id="view-products" class="hidden px-4">
                    <!-- flex-wrap, gap-4, px-4 from RN -->
                    <div class="flex flex-row flex-wrap gap-4" id="productsGrid">
                        <!-- Products rendered by JS with exact dimensions -->
                    </div>
                </div>

                <!-- RATING VIEW (Rating.tsx - Exact with RatingBar, AllRating, Comment) -->
                <div id="view-rating" class="hidden p-4">

                    <!-- RatingBar Component (Exact) -->
                    <div class="p-4 rounded-xl mb-4" style="min-height: 200px;">
                        <div class="flex flex-row justify-between items-center">
                            <span class="text-white font-bold text-xl">3.0 rating</span>
                            <span class="text-white font-semibold text-lg">200 reviews</span>
                        </div>
                        <!-- Rating bars (exact height: 13, rounded: 100, bg: #40444B) -->
                        <div class="mt-4 flex flex-col gap-2">
                            <!-- 5 Star -->
                            <div class="flex flex-row items-center gap-2">
                                <span class="text-white font-semibold text-xl">5</span>
                                <div class="flex flex-row items-center gap-2 flex-grow">
                                    <div class="w-[86%] rounded-[100px] bg-[#40444B] overflow-hidden"
                                        style="height: 13px;">
                                        <div class="bg-white h-full" style="width: 80%"></div>
                                    </div>
                                    <span class="text-white font-medium text-lg">80%</span>
                                </div>
                            </div>
                            <!-- 4 Star -->
                            <div class="flex flex-row items-center gap-2">
                                <span class="text-white font-semibold text-xl">4</span>
                                <div class="flex flex-row items-center gap-2 flex-grow">
                                    <div class="w-[86%] rounded-[100px] bg-[#40444B] overflow-hidden"
                                        style="height: 13px;">
                                        <div class="bg-white h-full" style="width: 60%"></div>
                                    </div>
                                    <span class="text-white font-medium text-lg">60%</span>
                                </div>
                            </div>
                            <!-- 3 Star -->
                            <div class="flex flex-row items-center gap-2">
                                <span class="text-white font-semibold text-xl">3</span>
                                <div class="flex flex-row items-center gap-2 flex-grow">
                                    <div class="w-[86%] rounded-[100px] bg-[#40444B] overflow-hidden"
                                        style="height: 13px;">
                                        <div class="bg-white h-full" style="width: 40%"></div>
                                    </div>
                                    <span class="text-white font-medium text-lg">40%</span>
                                </div>
                            </div>
                            <!-- 2 Star -->
                            <div class="flex flex-row items-center gap-2">
                                <span class="text-white font-semibold text-xl">2</span>
                                <div class="flex flex-row items-center gap-2 flex-grow">
                                    <div class="w-[86%] rounded-[100px] bg-[#40444B] overflow-hidden"
                                        style="height: 13px;">
                                        <div class="bg-white h-full" style="width: 20%"></div>
                                    </div>
                                    <span class="text-white font-medium text-lg">20%</span>
                                </div>
                            </div>
                            <!-- 1 Star -->
                            <div class="flex flex-row items-center gap-2">
                                <span class="text-white font-semibold text-xl">1</span>
                                <div class="flex flex-row items-center gap-2 flex-grow">
                                    <div class="w-[86%] rounded-[100px] bg-[#40444B] overflow-hidden"
                                        style="height: 13px;">
                                        <div class="bg-white h-full" style="width: 10%"></div>
                                    </div>
                                    <span class="text-white font-medium text-lg">10%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AllRating Component (Exact) -->
                    <div class="p-4">
                        <h3 class="text-white text-lg font-medium mb-4">All Reviews</h3>
                        <div class="flex flex-col gap-4">
                            <!-- Single Review Item (exact dimensions from AllRating.tsx) -->
                            <div class="flex flex-col gap-4">
                                <div class="flex flex-row gap-4">
                                    <!-- Avatar (height: 63, width: 63, rounded-full, bg: #292B2F99, border: #DADADA) -->
                                    <div class="rounded-full border"
                                        style="height: 63px; width: 63px; background-color: #292B2F99; border-color: #DADADA;">
                                    </div>
                                    <div class="flex flex-col justify-between py-1">
                                        <span class="text-white font-medium text-lg pl-8">Anonymous name</span>
                                        <div class="flex flex-row gap-2">
                                            <div class="flex flex-row gap-1">
                                                <span class="text-white text-base"></span>
                                            </div>
                                            <span class="text-white font-medium text-lg">Time / Day</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- Comment Bubble (rounded: 12, height: 90, bg: #292B2FCC) -->
                                <div class="w-full rounded-[12px] p-2"
                                    style="height: 90px; background-color: #292B2FCC;">
                                    <p class="text-white px-5 py-2 text-lg font-normal">
                                        Lorem ipsum dolor sit amet consectetur adipisicing elit.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Comment Component (Exact input with Star trigger and Tags popup) -->
                    <div class="p-4 relative mb-[150px]" style="z-index: 5; height: 200px;">

                        <!-- Rating/Tags Popup (showRateView from Comment.tsx) -->
                        <div id="ratingPopup" class="absolute left-0 right-0 hidden bg-transparent"
                            style="top: -60px; z-index: 10;">
                            <div
                                class="flex flex-row items-center gap-4 py-2 overflow-x-auto hide-scrollbar justify-center">
                                <!-- Stars Container (height: 45, width: 216, rounded: 100, bg: black) -->
                                <div class="flex flex-row items-center justify-center gap-4 ml-2 rounded-[100px] bg-black"
                                    style="height: 45px; width: 216px;">
                                    <button onclick="setStarRating(1)" class="w-6 h-6 star-rating-btn">
                                        <svg fill="#666" viewBox="0 0 24 24">
                                            <path
                                                d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                                        </svg>
                                    </button>
                                    <button onclick="setStarRating(2)" class="w-6 h-6 star-rating-btn">
                                        <svg fill="#666" viewBox="0 0 24 24">
                                            <path
                                                d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                                        </svg>
                                    </button>
                                    <button onclick="setStarRating(3)" class="w-6 h-6 star-rating-btn">
                                        <svg fill="#666" viewBox="0 0 24 24">
                                            <path
                                                d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                                        </svg>
                                    </button>
                                    <button onclick="setStarRating(4)" class="w-6 h-6 star-rating-btn">
                                        <svg fill="#666" viewBox="0 0 24 24">
                                            <path
                                                d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                                        </svg>
                                    </button>
                                    <button onclick="setStarRating(5)" class="w-6 h-6 star-rating-btn">
                                        <svg fill="#666" viewBox="0 0 24 24">
                                            <path
                                                d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                                        </svg>
                                    </button>
                                </div>

                                <!-- Tags Chips (height: 35, px: 24, rounded: 100, bg: #40444B) -->
                                <button onclick="toggleTag(this)"
                                    class="flex items-center justify-center rounded-[100px] bg-[#40444B] text-white text-lg font-semibold capitalize border border-transparent"
                                    style="height: 35px; padding: 0 24px;">
                                    Sachets
                                </button>
                                <button onclick="toggleTag(this)"
                                    class="flex items-center justify-center rounded-[100px] bg-[#40444B] text-white text-lg font-semibold capitalize border border-transparent"
                                    style="height: 35px; padding: 0 24px;">
                                    Bottle
                                </button>
                                <button onclick="toggleTag(this)"
                                    class="flex items-center justify-center rounded-[100px] bg-[#40444B] text-white text-lg font-semibold capitalize border border-transparent"
                                    style="height: 35px; padding: 0 24px;">
                                    Dispenser
                                </button>
                            </div>
                        </div>

                        <!-- Input Row (exact height: 43, rounded: 46, bg: #292B2FCC) -->
                        <div class="flex flex-row items-center gap-4">
                            <div class="border flex flex-row items-center px-5 gap-4 mt-3 rounded-[46px]"
                                style="height: 43px; background-color: #292B2FCC; border-color: var(--input-border); width: calc(100% - 60px);">
                                <input type="text" placeholder="Write a review.."
                                    class="bg-transparent border-none outline-none text-white text-lg flex-grow placeholder-white/60">
                                <!-- Star Icon Trigger -->
                                <button onclick="toggleRatingPopup()">
                                    <svg class="w-5 h-5 opacity-50 hover:opacity-100" fill="gold" viewBox="0 0 24 24">
                                        <path
                                            d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                                    </svg>
                                </button>
                            </div>
                            <!-- Send Button (height: 43, width: 43, rounded-full) -->
                            <button onclick="submitReview()" class="mt-3 border rounded-full flex items-center justify-center"
                                style="background-color: var(--btn-color); border-color: var(--btn-border); height: 43px; width: 43px;">
                                <svg class="w-6 h-6" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                                    <line x1="22" y1="2" x2="11" y2="13"></line>
                                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                </svg>
                            </button>
                        </div>
                    </div>

                </div>

            </div>
        </div>

    </div>

    <!-- Product Details Modal (from schedule.tsx bottom sheet) -->
    <div id="productModal"
        class="fixed inset-0 z-50 flex items-center justify-center pointer-events-none opacity-0 transition-opacity duration-300"
        style="background-color: rgba(0,0,0,0.5);">
        <div id="productModalContent"
            class="pointer-events-auto bg-[#1D1D1D] w-full max-w-[400px] h-[400px] rounded-[30px] p-5 flex flex-col items-center relative transform translate-y-full transition-transform duration-300">
            <button onclick="closeProductModal()"
                class="absolute top-4 left-4 z-10 w-10 h-10 flex items-center justify-center">
                <img src="images/main/ArrowLeftIcon.png" class="w-6 h-6">
            </button>
            <div class="w-full h-full flex flex-col items-center justify-center gap-4">
                <img id="modalProductImage" src="images/main/ProductImage1.png"
                    class="h-[200px] object-contain">
                <h2 id="modalProductName" class="text-white text-2xl font-bold">Product Name</h2>
                <p id="modalProductDescription" class="text-white text-lg text-center px-4">Product Description</p>
                <p id="modalProductPrice" class="text-white text-xl">GHS 0.00</p>
            </div>
        </div>
    </div>

    <!-- Social Media Modal -->
    <div id="socialModal" class="fixed inset-0 z-50 flex items-center justify-center p-9 hidden"
        style="background-color: rgba(0,0,0,0.5); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);">
        <div class="rounded-[30px] w-full max-w-[350px] h-[200px] px-10 py-7 flex flex-col items-center justify-center border-[0.2px]"
            style="background-color: #1D1D1D; border-color: rgba(255,255,255,0.1);">

            <div class="flex-1 w-full items-center flex-col justify-center relative">
                <!-- Icon Section -->
                <div class="items-center flex-1 w-full relative flex items-center justify-center mb-4">
                    <div class="w-[60px] h-[60px] rounded-full flex items-center justify-center"
                         style="background-color: #3B74FF;">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                        </svg>
                    </div>
                </div>

                <!-- Text Section -->
                <div class="w-full flex-1 flex-col items-center justify-center text-center">
                    <h2 class="text-white text-center text-xl font-semibold mb-2">
                        Social Media Unavailable
                    </h2>
                    <p class="text-white text-center text-base font-normal">
                        <span id="socialPlatformName">Facebook</span> page is not available at the moment.
                    </p>
                    <p class="text-white text-center text-sm font-normal mt-2 opacity-75">
                        Please try again later or contact us directly.
                    </p>
                </div>

                <!-- Button Section -->
                <div class="w-full flex-1 flex-col items-center justify-end mt-6">
                    <button onclick="closeSocialModal()"
                        class="h-[37px] w-[177px] rounded-[100px] flex items-center justify-center border mx-auto"
                        style="background-color: var(--btn-color); border-color: var(--btn-border);">
                        <span class="text-white text-base font-semibold capitalize"
                            style="font-weight: 500;">Close</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Terms of Service Modal -->
    <div id="termsModal" class="fixed inset-0 z-[70] flex items-center justify-center p-4 hidden"
        style="background-color: rgba(0,0,0,0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);">
        <div class="rounded-[20px] w-full max-w-[400px] h-[80vh] bg-[#1D1D1D] border border-[rgba(255,255,255,0.1)] flex flex-col">
            <!-- Header -->
            <div class="flex items-center justify-between p-4 border-b border-[rgba(255,255,255,0.1)] flex-shrink-0">
                <h3 class="text-white text-xl font-semibold">Terms of Service</h3>
                <button onclick="closeTermsModal()" class="w-8 h-8 flex items-center justify-center rounded-full bg-[rgba(255,255,255,0.1)] hover:bg-[rgba(255,255,255,0.2)] transition-colors">
                    <span class="text-white text-lg"></span>
                </button>
            </div>
            
            <!-- Content with Notion iframe -->
            <div class="flex-1 overflow-hidden">
                <iframe src="https://concrete-aurora-836.notion.site/ebd//1c7c077ea6428075b4c6f68ad38d15c1" 
                        width="100%" 
                        height="100%" 
                        frameborder="0" 
                        allowfullscreen
                        class="rounded-b-[20px]">
                </iframe>
            </div>
        </div>
    </div>

    <!-- Schedule Flow Bottom Sheet (NEW VERSION - Integrated from second file) -->
    <div id="scheduleFlowSheet"
        class="bottom-sheet-container fixed inset-0 z-[60] flex items-end justify-center pointer-events-none">

        <!-- Content -->
        <div id="scheduleFlowContent" class="bottom-sheet-content w-full max-w-[400px] flex flex-col relative"
            style="height: 85vh;">

            <!-- Drag Handle -->
            <div class="sheet-drag-handle"></div>

            <!-- Step Indicators (Hidden as requested) -->
            <div class="step-indicator-container" style="display: none;">
                <div class="step-indicator-line"></div>
                <div class="step-indicator-wrapper px-6">
                    <div id="stepTermsIndicator" class="step-indicator-item default">
                        <span class="step-indicator-name">Terms</span>
                    </div>
                    <div id="stepRecipientIndicator" class="step-indicator-item default">
                        <span class="step-indicator-name">Recipient</span>
                    </div>
                    <div id="stepQuantityIndicator" class="step-indicator-item default">
                        <span class="step-indicator-name">Quantity</span>
                    </div>
                    <div id="stepReviewIndicator" class="step-indicator-item default">
                        <span class="step-indicator-name">Review</span>
                    </div>
                    <div id="stepPaymentIndicator" class="step-indicator-item default">
                        <span class="step-indicator-name">Payment</span>
                    </div>
                </div>
            </div>

            <!-- Close Button -->
            <button onclick="closeScheduleFlow()"
                class="absolute top-4 right-4 z-10 w-10 h-10 flex items-center justify-center rounded-full bg-[rgba(255,255,255,0.1)] hover:bg-[rgba(255,255,255,0.2)] transition-colors">
                <span class="text-white text-2xl"></span>
            </button>

            <!-- Error Message Container -->
            <div id="errorMessage" class="error-message mx-6"></div>

            <!-- Success Message Container -->
            <div id="successMessage" class="success-message mx-6"></div>

            <!-- Step Content Container -->
            <div class="flex-1 overflow-y-auto hide-scrollbar px-6 pt-4">

                <!-- Step 1: Terms of Service (Radio Button Style) -->
                <div id="termsStep" class="step-content">
                    <h3 class="section-header">Terms of Service</h3>
                    <p class="section-subheader">Please select your order type:</p>

                    <div class="terms-radio-container">
                        <div onclick="selectTermsOption('schedule')" class="terms-radio-item selected"
                            id="termsSchedule">
                            <div class="terms-radio-label">
                                <div class="terms-radio-circle"></div>
                                Schedule Order
                            </div>
                            <div class="terms-details">
                                Place an order for future delivery. Orders must be scheduled at least 2 hours in
                                advance.
                            </div>
                        </div>

                        <div onclick="selectTermsOption('immediate')" class="terms-radio-item" id="termsImmediate">
                            <div class="terms-radio-label">
                                <div class="terms-radio-circle"></div>
                                Immediate Order
                            </div>
                            <div class="terms-details">
                                Order for immediate delivery. Subject to availability and current delivery conditions.
                            </div>
                        </div>
                    </div>

                    <div class="terms-container">
                        <p class="info-text">
                            By continuing you agree to our <a href="#" onclick="openTermsOfService()"
                                class="text-blue-400 hover:text-blue-300 underline">terms of service</a>
                        </p>
                    </div>
                </div>

                <!-- Step 2: Product Selection -->
                <div id="productSelectionStep" class="step-content hidden">
                    <h3 class="section-header">Select Products</h3>
                    <p class="section-subheader">Choose the products you want to order</p>

                    <div class="products-grid-container" id="productsSelectionGrid">
                        <!-- Products will be dynamically added here -->
                    </div>

                    <div class="info-card mt-4">
                        <div class="info-title">Important Note</div>
                        <div class="info-text">
                            You can adjust quantities after selecting products. Minimum order is 1 item per product.
                        </div>
                    </div>
                </div>

                <!-- Step 3: Order Recipient -->
                <div id="orderRecipientStep" class="step-content hidden">
                    <h3 class="section-header">Order Recipient</h3>
                    <p class="section-subheader">Who is this order for?</p>

                    <div class="recipient-type-container">
                        <button onclick="selectRecipientType('you')" class="recipient-type-btn active"
                            id="recipientYou">You</button>
                        <button onclick="selectRecipientType('individual')" class="recipient-type-btn"
                            id="recipientIndividual">Individual</button>
                        <button onclick="selectRecipientType('business')" class="recipient-type-btn"
                            id="recipientBusiness">Business</button>
                    </div>

                    <!-- Saved Recipients Toggle -->
                    <div class="toggle-container">
                        <span class="toggle-label">Save this for future orders</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="saveRecipientToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <!-- Saved Recipients (if any) -->
                    <div id="savedRecipientsContainer" class="saved-recipients-container hidden">
                        <p class="section-subheader">Select saved recipient:</p>
                        <div id="savedRecipientsList">
                            <!-- Saved recipients will be dynamically added here -->
                        </div>
                    </div>

                    <div class="form-container space-y-6">
                        <!-- You recipient info display -->
                        <div id="youRecipientInfo" class="you-recipient-info">
                            <div class="you-recipient-item">
                                <span class="you-recipient-label">Name:</span>
                                <span id="youNameDisplay" class="you-recipient-value">Loading...</span>
                            </div>
                            <div class="you-recipient-item">
                                <span class="you-recipient-label">Phone:</span>
                                <span id="youPhoneDisplay" class="you-recipient-value">Loading...</span>
                            </div>
                            <div class="you-recipient-item">
                                <span class="you-recipient-label">Email:</span>
                                <span id="youEmailDisplay" class="you-recipient-value">Loading...</span>
                            </div>
                            <div class="you-recipient-item">
                                <span class="you-recipient-label">Delivery Address:</span>
                                <span id="youAddressDisplay" class="you-recipient-value">Loading...</span>
                            </div>
                        </div>

                        <!-- Business Type Selector (hidden by default) -->
                        <div id="businessTypeContainer" class="business-type-container hidden">
                            <label class="form-label">Business Type</label>
                            <select id="businessType" class="business-type-select">
                                <option value="">Select Business Type</option>
                                <option value="school">School/Educational Institution</option>
                                <option value="hospital">Hospital/Clinic</option>
                                <option value="hotel">Hotel/Restaurant</option>
                                <option value="office">Office/Corporate</option>
                                <option value="church">Church/Religious Institution</option>
                                <option value="ngo">NGO/Non-Profit</option>
                                <option value="government">Government Agency</option>
                                <option value="factory">Factory/Manufacturing</option>
                                <option value="construction">Construction Site</option>
                                <option value="other">Other Business</option>
                            </select>
                        </div>

                        <!-- Name field (hidden for "You" type) -->
                        <div id="recipientNameContainer" class="hidden">
                            <label class="form-label">Full Name</label>
                            <input type="text" id="recipientName" class="form-input" placeholder="Enter recipient name">
                        </div>

                        <!-- Business Name Field (hidden by default, shown only for business type) -->
                        <div id="businessNameContainer" class="business-name-container hidden">
                            <label class="form-label">Business Name</label>
                            <input type="text" id="businessName" class="form-input" placeholder="Enter business name">
                        </div>

                        <!-- Phone field (hidden for "You" type) -->
                        <div id="recipientPhoneContainer" class="hidden">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" id="recipientPhone" class="form-input" placeholder="Enter phone number">
                        </div>

                        <!-- Email field (hidden for "You" type) -->
                        <div id="recipientEmailContainer" class="hidden">
                            <label class="form-label">Email Address</label>
                            <input type="email" id="recipientEmail" class="form-input"
                                placeholder="Enter email address">
                        </div>

                        <!-- Delivery Address (always shown) -->
                        <div>
                            <label class="form-label">Delivery Address *</label>
                            <textarea id="recipientAddress" rows="3" class="form-textarea"
                                placeholder="Full address or detailed location (e.g: 5th Floor, Block B, Ring Road)"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Date and Time Selection -->
                <div id="datetimeStep" class="step-content hidden">
                    <h3 class="section-header">Select Date & Time</h3>
                    <p class="section-subheader">Choose when you want your order delivered</p>

                    <div class="form-container space-y-6">
                        <div class="datetime-row">
                            <div class="datetime-input">
                                <label class="form-label">Delivery Date</label>
                                <input type="date" id="deliveryDate" class="form-input" min="">
                            </div>
                            <div class="datetime-input">
                                <label class="form-label">Delivery Time</label>
                                <select id="deliveryTime" class="form-input">
                                    <option value="">Select Time</option>
                                    <option value="08:00">8:00 AM</option>
                                    <option value="09:00">9:00 AM</option>
                                    <option value="10:00">10:00 AM</option>
                                    <option value="11:00">11:00 AM</option>
                                    <option value="12:00">12:00 PM</option>
                                    <option value="13:00">1:00 PM</option>
                                    <option value="14:00">2:00 PM</option>
                                    <option value="15:00">3:00 PM</option>
                                    <option value="16:00">4:00 PM</option>
                                    <option value="17:00">5:00 PM</option>
                                    <option value="18:00">6:00 PM</option>
                                </select>
                            </div>
                        </div>

                        <div class="time-slots-container">
                            <label class="form-label">Popular Time Slots</label>
                            <div class="time-slots-grid" id="timeSlotsGrid">
                                <!-- Time slots will be dynamically generated -->
                            </div>
                        </div>

                        <div class="info-card">
                            <div class="info-title">Important Note</div>
                            <div class="info-text">
                                Orders must be scheduled at least 2 hours in advance. Same-day delivery is subject to
                                availability.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Product Quantity Selection (Multiple Products) -->
                <div id="quantityStep" class="step-content hidden">
                    <div class="service-products-header">
                        <h3 class="section-header">Adjust Quantities</h3>
                        <button onclick="goToProductSelection()" class="add-more-btn">
                            + Add More Products
                        </button>
                    </div>
                    <p class="section-subheader">Adjust quantities for your selected products</p>

                    <!-- Selected Products Container -->
                    <div class="selected-products-container" id="selectedProductsContainer">
                        <!-- Selected products from service cards will appear here -->
                        <div class="no-products-selected">No products selected. Please go back and select products.</div>
                    </div>

                    <!-- Delivery Instructions -->
                    <div class="delivery-instructions">
                        <div class="instructions-title">Add additional Information</div>
                        <div class="instructions-example">Example: "Please Call Me On 024XXXXXXXX When You Arrive At The
                            Main Gate. The Security Guard Will Direct You."</div>
                        <textarea id="deliveryInstructions" rows="3" class="form-textarea"
                            placeholder="Enter delivery instructions..."></textarea>
                    </div>

                    <!-- Delivery Fee Information -->
                    <div class="delivery-info-note">
                        <strong>Please Note:</strong> Delivery Fees Are Charged By The Water Company, Not Phluowise.
                        Payment Must Be Made Upon Delivery To Confirm Receipt.
                    </div>

                    <!-- Price Summary -->
                    <div class="price-display mt-6">
                        <div class="price-row">
                            <span class="price-label">Subtotal</span>
                            <span id="quantitySubtotal" class="price-value">GHS 0.00</span>
                        </div>
                        <div class="price-row">
                            <span class="price-label">Service Fee (GHS 0.10 per item)</span>
                            <span id="serviceFeeDisplay" class="price-value">GHS 0.00</span>
                        </div>
                        <div class="price-row total">
                            <span class="price-label">Total Amount</span>
                            <span id="quantityTotal" class="price-value total">GHS 0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Step 6: Order Review -->
                <div id="orderReviewStep" class="step-content hidden">
                    <h3 class="section-header">Review Your Order</h3>

                    <!-- Order Summary -->
                    <div class="review-card">
                        <div class="review-section">
                            <h4 class="review-section-title">Order Summary</h4>
                            <div id="reviewProductsList">
                                <!-- Products will be dynamically added here -->
                            </div>
                        </div>
                    </div>

                    <!-- Delivery Information -->
                    <div class="review-card">
                        <div class="review-section">
                            <h4 class="review-section-title">Delivery Information</h4>
                            <div class="review-item">
                                <span class="review-label">Date:</span>
                                <span id="reviewDeliveryDate" class="review-value"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Time:</span>
                                <span id="reviewDeliveryTime" class="review-value"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Address:</span>
                                <span id="reviewDeliveryAddress" class="review-value"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Delivery Instructions -->
                    <div class="review-card">
                        <div class="review-section">
                            <h4 class="review-section-title">Delivery Instructions</h4>
                            <div class="review-value" id="reviewDeliveryInstructions">None provided</div>
                        </div>
                    </div>

                    <!-- Price Summary -->
                    <div class="review-card">
                        <div class="review-section">
                            <h4 class="review-section-title">Payment Summary</h4>
                            <div class="review-item">
                                <span class="review-label">Subtotal</span>
                                <span id="reviewSubtotal" class="review-value">GHS 0.00</span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Service Fee (GHS 0.10 per item)</span>
                                <span id="reviewServiceFee" class="review-value">GHS 0.00</span>
                            </div>
                            <div class="review-item"
                                style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px;">
                                <span class="review-label">Total Amount</span>
                                <span id="reviewTotal" class="review-value"
                                    style="color: #3B74FF; font-weight: 600;">GHS 0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Delivery Fee Note -->
                    <div class="delivery-info-note">
                        <strong>Please Note:</strong> Delivery Fees Are Charged By The Water Company, Not Phluowise.
                        Payment Must Be Made Upon Delivery To Confirm Receipt.
                    </div>
                </div>

                <!-- Step 7: Payment -->
                <div id="selectPaymentStep" class="step-content hidden">
                    <h3 class="section-header">Payment Method</h3>
                    <p class="section-subheader">Select your preferred payment method</p>

                    <!-- Mobile Money Only -->
                    <div onclick="selectPaymentMethod('mobile')" class="payment-method-card">
                        <div class="payment-method-icon mobile">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
                            </svg>
                        </div>
                        <div class="payment-method-name">Mobile Money</div>
                        <div class="payment-method-desc">MTN, Vodafone, AirtelTigo</div>
                        <div class="payment-check">
                            <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                    d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                    </div>

                    <div class="mobile-payment-note">
                        You will receive a prompt on your mobile phone to complete the payment.
                    </div>
                </div>

                <!-- Step 8: Input Payment Details (Mobile Money Only) -->
                <div id="paymentDetailsStep" class="step-content hidden">
                    <h3 class="section-header">Mobile Money Details</h3>

                    <div class="form-container space-y-4">
                        <div>
                            <label class="form-label">Mobile Network</label>
                            <select id="mobileNetwork" class="form-input">
                                <option value="">Select Network</option>
                                <option value="mtn">MTN Mobile Money</option>
                                <option value="vodafone">Vodafone Cash</option>
                                <option value="airteltigo">AirtelTigo Money</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Phone Number</label>
                            <input type="tel" id="mobileNumber" class="form-input" placeholder="0201234567">
                        </div>
                    </div>
                </div>

                <!-- Step 9: Payment Confirmation Processing -->
                <div id="paymentProcessingStep" class="step-content hidden">
                    <div class="flex flex-col items-center justify-center h-full text-center">
                        <div class="processing-spinner"></div>
                        <h3 class="section-header mb-2">Processing Payment</h3>
                        <p class="section-subheader">Please wait while we process your payment securely...</p>
                        <div class="progress-bar-container">
                            <div id="paymentProgressBar" class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Step 10: Payment Success -->
                <div id="paymentSuccessStep" class="step-content hidden">
                    <div class="flex flex-col items-center justify-center h-full text-center">
                        <div class="success-icon">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                        <h3 class="section-header mb-2">Payment Successful!</h3>
                        <p class="section-subheader mb-6">Your payment has been processed successfully</p>
                        <div class="review-card w-full mb-6">
                            <div class="review-item">
                                <span class="review-label">Transaction ID:</span>
                                <span id="transactionIdDisplay" class="review-value"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Amount Paid:</span>
                                <span id="amountPaidDisplay" class="review-value" style="color: #10B981;"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 11: Schedule Pickup Sent & Rate Phluowise -->
                <div id="scheduleSentStep" class="step-content hidden">
                    <div class="flex flex-col items-center h-full text-center">
                        <div class="success-icon"
                            style="background: rgba(59, 116, 255, 0.2); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 2px solid rgba(59, 116, 255, 0.4); margin-bottom: 24px;">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                        </div>
                        <h3 class="section-header mb-2">Schedule Pickup Sent!</h3>
                        <p class="section-subheader mb-6">Your order has been successfully scheduled and confirmed</p>

                        <div class="review-card w-full mb-6">
                            <h4 class="review-section-title mb-4">Order Summary</h4>
                            <div class="review-item">
                                <span class="review-label">Order ID:</span>
                                <span id="orderIdDisplay" class="review-value"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Delivery Date:</span>
                                <span id="orderDateDisplay" class="review-value"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Delivery Time:</span>
                                <span id="orderTimeDisplay" class="review-value"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Total Items:</span>
                                <span id="orderItemsDisplay" class="review-value"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Status:</span>
                                <span class="review-value" style="color: #10B981;">Confirmed</span>
                            </div>
                        </div>

                        <!-- Download PDF Button -->
                        <div class="w-full mb-6">
                            <button onclick="downloadOrderPDF()" class="w-full py-4 rounded-lg backdrop-blur-xl bg-[#007ACC]/20 border border-[#007ACC]/40 text-white font-medium hover:bg-[#007ACC]/30 transition-all duration-300 shadow-lg flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Download Order PDF
                            </button>
                        </div>

                        <!-- Rating Section -->
                        <div class="w-full">
                            <h4 class="review-section-title mb-4">Rate Phluowise</h4>
                            <p class="section-subheader mb-6">How was your experience with our service?</p>

                            <div class="rating-stars-container">
                                <div onclick="setRating(1)" class="rating-star-large"></div>
                                <div onclick="setRating(2)" class="rating-star-large"></div>
                                <div onclick="setRating(3)" class="rating-star-large"></div>
                                <div onclick="setRating(4)" class="rating-star-large"></div>
                                <div onclick="setRating(5)" class="rating-star-large"></div>
                            </div>

                            <textarea id="ratingComment" rows="3" class="form-textarea mt-4"
                                placeholder="Share your experience (optional)..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Step 12: Rating Success -->
                <div id="ratingSuccessStep" class="step-content hidden">
                    <div class="flex flex-col items-center justify-center h-full text-center">
                        <div class="success-icon" style="width: 80px; height: 80px;">
                            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                        <h3 class="section-header mb-4">Thank You!</h3>
                        <p class="text-lg text-gray-300 mb-2">Your rating has been submitted</p>
                        <p class="section-subheader mb-6">We appreciate your feedback</p>

                        <div class="review-card w-full mb-6">
                            <div class="review-item">
                                <span class="review-label">Order ID:</span>
                                <span id="finalOrderId" class="review-value"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Delivery Date:</span>
                                <span id="finalDeliveryDate" class="review-value"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Rating:</span>
                                <span id="finalRatingStars" class="review-value"
                                    style="color: #FCD34D; font-size: 18px;"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Total Paid:</span>
                                <span id="finalTotalPaid" class="review-value" style="color: #3B74FF;"></span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Navigation Buttons (Improved) -->
            <div class="step-navigation px-6 pb-6">
                <button id="prevBtn" onclick="previousStep()" class="nav-btn prev hidden">
                    Back
                </button>
                <button id="nextBtn" onclick="nextStep()" class="nav-btn next">
                    Continue
                </button>
                <button id="payBtn" onclick="processPayment()" class="nav-btn pay hidden">
                    Pay Now
                </button>
                <button id="doneBtn" onclick="finishFlow()" class="nav-btn done hidden">
                    Done
                </button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation (Schedule History renamed) -->
    <div
        class="tab-bar fixed bottom-0 left-0 right-0 h-[64px] flex flex-row justify-around items-center px-4 border-t-0 bg-[#101010] z-50">
        <a href="home.html" class="flex flex-col items-center justify-center gap-1 flex-1">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="1.5">
                <path
                    d="M9.02 2.84004L3.63 7.04004C2.73 7.74004 2 9.23004 2 10.36V17.77C2 20.09 3.89 21.99 6.21 21.99H17.79C20.11 21.99 22 20.09 22 17.78V10.5C22 9.29004 21.19 7.74004 20.2 7.05004L14.02 2.72004C12.62 1.74004 10.37 1.79004 9.02 2.84004Z"
                    stroke-linecap="round" stroke-linejoin="round" />
                <path d="M12 17.99V14.99" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <span class="text-sm text-white font-normal mt-1">Home</span>
        </a>
        <a href="services.html" class="flex flex-col items-center justify-center gap-1 flex-1">
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none" stroke="#FFFFFF" stroke-width="1.5">
                <path
                    fill="#FFFFFF"
                    d="m31.696 15.098-1.75-4.376a1.742 1.742 0 0 0-1.625-1.1H23.75V8.376a.75.75 0 0 0-.75-.75H4a1.75 1.75 0 0 0-1.75 1.75v14A1.75 1.75 0 0 0 4 25.125h2.325a3.75 3.75 0 0 0 7.35 0h6.65a3.75 3.75 0 0 0 7.35 0H30a1.75 1.75 0 0 0 1.75-1.75v-8a.752.752 0 0 0-.054-.277Zm-7.946-3.973h4.573a.25.25 0 0 1 .232.158l1.337 3.342H23.75v-3.5Zm-20-1.75a.25.25 0 0 1 .25-.25h18.25v8.5H3.75v-8.25ZM10 26.625a2.25 2.25 0 1 1 0-4.5 2.25 2.25 0 0 1 0 4.5Zm10.325-3h-6.65a3.75 3.75 0 0 0-7.35 0H4a.25.25 0 0 1-.25-.25v-4.25h18.5v1.935a3.763 3.763 0 0 0-1.925 2.565Zm3.675 3a2.25 2.25 0 1 1 0-4.5 2.25 2.25 0 0 1 0 4.5Zm6.25-3.25a.25.25 0 0 1-.25.25h-2.325a3.756 3.756 0 0 0-3.675-3c-.084 0-.168 0-.25.009v-4.509h6.5v7.25Z"
                />
            </svg>
            <span class="text-sm text-white font-normal mt-1">Services</span>
        </a>
        <a href="schedule-history.html" class="flex flex-col items-center justify-center gap-1 flex-1">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="1.5">
                <path d="M8 2V5" />
                <path d="M16 2V5" />
                <path
                    d="M3.5 9.09H20.5" />
                <path d="M3.5 9.09H20.5" />
                <path
                    d="M18.2 21.4C19.9673 21.4 21.4 19.9673 21.4 18.2C21.4 16.4327 19.9673 15 18.2 15C16.4327 15 15 16.4327 15 18.2C15 19.9673 16.4327 21.4 18.2 21.4Z" />
                <path d="M22 22L21 21" />
                <path
                    d="M21 8.5V13.63C20.27 13.14 19.38 12.85 18.43 12.85C15.86 12.85 13.78 14.95 13.78 17.54C13.78 18.45 14.04 19.29 14.49 20H8C4.5 20 3 18 3 15V8.5C3 5.5 4.5 3.5 8 3.5H16C19.5 3.5 21 5.5 21 8.5Z" />
            </svg>
            <span class="text-sm text-white font-normal mt-1">Schedule History</span>
        </a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
    <script src="js/appwriteConfig.js"></script>
    <script src="js/companyData.js"></script>
    <script src="js/theme.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Global variables for the schedule flow
        let currentStep = 1;
        const totalSteps = 12; // Increased to 12 steps
        let selectedPaymentMethod = null;
        let orderData = {
            recipient: {},
            products: [],
            subtotal: 0,
            serviceFee: 0,
            total: 0
        };
        let userRating = 0;
        let selectedCompany = '';
        let recipientType = 'you';
        const SERVICE_FEE_PER_ITEM = 0.10;
        let savedRecipients = [];
        let selectedSavedRecipient = null;
        let selectedDate = '';
        let selectedTime = '';
        let selectedProducts = [];

        // Products data for the company (fetched from Appwrite)
        let companyProducts = [];

        async function fetchProductsForCurrentBranch() {
            try {
                // Ensure Appwrite is available
                if (!window.databases || !window.appwriteConfig) {
                    console.error(' Appwrite not available for products - SDK not loaded');
                    return;
                }

                // Get branch_id from URL
                const urlParams = new URLSearchParams(window.location.search);
                const branchId = urlParams.get('branch_id');

                // If branch data already loaded, prefer using its IDs
                let filterQueries = [];
                const branchData = window.currentCompany && window.currentCompany.branch_id ? window.currentCompany : null;
                const resolvedBranchId = branchData?.branch_id || branchId;
                const resolvedCompanyId = branchData?.company_id;

                if (resolvedBranchId) {
                    filterQueries.push(window.Query.equal('branch_id', resolvedBranchId));
                }
                if (resolvedCompanyId) {
                    filterQueries.push(window.Query.equal('company_id', resolvedCompanyId));
                }

                // Fallback: no branch/company filter, just fetch all and filter client-side
                const response = await window.databases.listDocuments(
                    window.appwriteConfig.DATABASE_ID,
                    window.appwriteConfig.PRODUCTS_TABLE,
                    filterQueries.length > 0 ? filterQueries : [window.Query.orderDesc('$createdAt')]
                );

                const productsFromDb = response.documents || [];

                // Map DB fields to UI model, including image resolution
                companyProducts = productsFromDb.map((doc, index) => {
                    const type = (doc.product_type || '').toLowerCase();

                    // Determine image: prefer product_image, else type-based fallback, else branch/company profile
                    let imageUrl = doc.product_image || '';
                    if (!imageUrl) {
                        if (type.includes('dispenser')) imageUrl = 'images/products/dispenser.jpg';
                        else if (type.includes('bottle')) imageUrl = 'images/products/bottle.jpg';
                        else if (type.includes('sachet') || type.includes('sachets')) imageUrl = 'images/products/sachets.jpg';
                        else imageUrl = 'images/main/ProductImage1.png';
                    }

                    // Quantity default to 1, ensure numeric price
                    const priceNum = parseFloat(doc.price) || 0;

                    return {
                        id: doc.product_id || doc.$id || index + 1,
                        name: doc.product_name || 'Product',
                        price: priceNum,
                        image: imageUrl,
                        quantity: 1,
                        description: doc.size ? `${doc.size}` : (doc.product_type || 'Product')
                    };
                });

                // Refresh selection grid UI if on product selection step
                if (typeof updateProductSelectionStep === 'function') {
                    updateProductSelectionStep();
                }

                // Also refresh Products subview grid
                if (typeof renderProducts === 'function') {
                    renderProducts();
                }
            } catch (error) {
                console.error(' Error fetching products:', error);
            }
        }

        // Trigger fetching after branch data is loaded and DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // After branch info updates, fetch related products
            fetchProductsForCurrentBranch();
        });

        // Variables from original schedule.html
        let readMore = false;
        let subView = 'schedule';
        let map;
        let userLocation = null;
        let companyMarker = null;
        let userMarker = null;
        let currentTileLayer = null;
        let isSatelliteView = false;

        // Current company data
        const currentCompany = {
            id: 1,
            name: 'Voltic Water Company',
            location: 'Accra, Ghana',
            coordinates: { lat: 5.6037, lng: -0.1870 },
            phone: '+233 24 123 4567',
            workingHours: {
                monday: { open: '08:00', close: '17:00', isOpen: true },
                tuesday: { open: '08:00', close: '17:00', isOpen: true },
                wednesday: { open: '08:00', close: '17:00', isOpen: true },
                thursday: { open: '08:00', close: '17:00', isOpen: true },
                friday: { open: '08:00', close: '17:00', isOpen: true },
                saturday: { open: '09:00', close: '14:00', isOpen: true },
                sunday: { open: 'Closed', close: 'Closed', isOpen: false }
            }
        };

        // Sample products (exact from Products.tsx structure)
        const products = [
            { price: 10, name: 'Sachets water', type: 'Description of product', image: 'images/main/ProductImage1.png' },
            { price: 20, name: 'Bottle water', type: 'Description of product', image: 'images/main/ProductImage1.png' },
            { price: 15, name: 'Dispenser', type: 'Description of product', image: 'images/main/ProductImage1.png' },
            { price: 12, name: 'Sachets water', type: 'Description of product', image: 'images/main/ProductImage1.png' }
        ];

        // Rating system state
        let currentRating = 0;
        let selectedTags = new Set();
        let reviews = [
            {
                id: 1,
                name: 'Anonymous name',
                rating: 5,
                comment: 'Lorem ipsum dolor sit amet consectetur adipisicing elit.',
                tags: ['Sachets'],
                date: new Date('2024-01-15')
            },
            {
                id: 2,
                name: 'John Doe',
                rating: 4,
                comment: 'Great service and fast delivery. Highly recommend!',
                tags: ['Bottle'],
                date: new Date('2024-01-10')
            },
            {
                id: 3,
                name: 'Jane Smith',
                rating: 3,
                comment: 'Good quality products, delivery was on time.',
                tags: ['Dispenser'],
                date: new Date('2024-01-05')
            }
        ];

        // Functions from original schedule.html
        function toggleReadMore() {
            readMore = !readMore;
            const container = document.getElementById('descriptionContainer');
            const gradient = document.getElementById('descGradient');
            const text = document.getElementById('readMoreText');

            if (readMore) {
                container.style.height = 'auto';
                gradient.style.display = 'none';
                text.textContent = 'less -';
            } else {
                container.style.height = '45px';
                gradient.style.display = 'block';
                text.textContent = 'more +';
            }
        }

        function setSubView(view) {
            subView = view;
            const btns = ['schedule', 'products', 'rating'];
            btns.forEach(btn => {
                const button = document.getElementById('btn-' + btn);
                if (btn === view) {
                    button.style.backgroundColor = 'var(--btn-color)';
                    button.style.borderColor = 'var(--btn-border)';
                } else {
                    button.style.backgroundColor = 'transparent';
                    button.style.borderColor = 'transparent';
                }
            });

            document.getElementById('view-schedule').style.display = view === 'schedule' ? 'block' : 'none';
            document.getElementById('view-products').style.display = view === 'products' ? 'block' : 'none';
            document.getElementById('view-rating').style.display = view === 'rating' ? 'block' : 'none';

            if (view === 'products') renderProducts();
        }

        function renderProducts() {
            const container = document.getElementById('productsGrid');
            container.innerHTML = '';

            const list = (Array.isArray(companyProducts) && companyProducts.length > 0) ? companyProducts : products;

            list.forEach((p, i) => {
                const card = document.createElement('div');
                card.className = "relative overflow-hidden rounded-[10px]";
                card.style.width = "calc(50% - 8px)";
                card.style.height = "220px";
                card.style.backgroundColor = "var(--card-bg-dark)";

                const priceText = Number(p.price || 0).toFixed(2);
                const descText = p.description || p.type || '';

                card.innerHTML = `
                    <!-- Top Blur (intensity: 70, height: 40, zIndex: 2) -->
                    <div class="absolute top-0 left-0 right-0 px-2 flex flex-row justify-between items-center z-10 glass-blur-70" style="height: 40px;">
                         <span class="text-white font-[700] text-lg">GHS ${priceText}</span>
                         <div class="w-[15px] h-[15px] bg-white/50 rounded-sm"></div>
                    </div>
                    
                    <img src="${p.image}" class="w-full h-full object-cover">
                    
                    <!-- Bottom Blur (intensity: 50, height: 50, zIndex: 2) -->
                    <div class="absolute bottom-0 left-0 right-0 px-2 py-1 flex flex-row justify-between items-center gap-1 z-10 glass-blur-50" style="height: 50px;">
                         <div>
                              <span class="text-white font-[600] block leading-tight truncate" style="width: 110px;">${p.name}</span>
                              <span class="text-white font-[400] text-sm block leading-tight truncate" style="width: 110px;">${descText}</span>
                         </div>
                         <!-- Button (height: 25, rounded: 5, bg: #40444B, shadow) -->
                         <button class="bg-[#40444B] rounded-[5px] px-2 flex items-center justify-center transform active:scale-95 transition-transform"
                                 onclick="openProductModal('${p.name}', ${Number(p.price || 0)}, '${descText}')"
                                 style="height: 25px; box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.25);">
                              <span class="text-white text-sm font-[500]">less +</span>
                         </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function updateWorkingHours() {
            const select = document.getElementById('workingDaysSelect');
            const openingTimeSpan = document.getElementById('openingTime');
            const closingTimeSpan = document.getElementById('closingTime');
            
            if (!select || !select.value) {
                openingTimeSpan.textContent = 'Closed';
                closingTimeSpan.textContent = 'Closed';
                openingTimeSpan.style.color = '#F57D7D';
                closingTimeSpan.style.color = '#F57D7D';
                return;
            }
            
            const selectedDay = select.value;
            const dayHours = window.currentCompany?.workingHours?.[selectedDay];
            
            // Check if day exists and has both opening and closing times
            if (!dayHours || !dayHours.open || !dayHours.close || dayHours.open === '' || dayHours.close === '') {
                openingTimeSpan.textContent = 'Closed';
                closingTimeSpan.textContent = 'Closed';
                openingTimeSpan.style.color = '#FF0000'; // Red color for Closed
                closingTimeSpan.style.color = '#FF0000'; // Red color for Closed
                console.log(`${selectedDay}: Closed (no opening/closing times set)`);
                return;
            }
            
            openingTimeSpan.textContent = dayHours.open;
            closingTimeSpan.textContent = dayHours.close;
            openingTimeSpan.style.color = '#FFFFFF'; // Reset to normal color
            closingTimeSpan.style.color = '#FFFFFF'; // Reset to normal color
            console.log(`${selectedDay}: ${dayHours.open} - ${dayHours.close}`);
            
            // Highlight today
            const today = new Date().toLocaleDateString('en-US', { weekday: 'short' }).toLowerCase();
            const dayMapping = {
                'mon': 'monday', 'tue': 'tuesday', 'wed': 'wednesday',
                'thu': 'thursday', 'fri': 'friday', 'sat': 'saturday', 'sun': 'sunday'
            };
            
            const currentDay = dayMapping[today] || 'monday';
            if (selectedDay === currentDay) {
                select.style.backgroundColor = '#3B74FF';
                select.style.color = '#FFFFFF';
            } else {
                select.style.backgroundColor = '#202225';
                select.style.color = '#FFFFFF';
            }
        }

        function setCurrentDay() {
            const select = document.getElementById('workingDaysSelect');
            
            if (!select) {
                return;
            }
            
            const today = new Date().toLocaleDateString('en-US', { weekday: 'short' }).toLowerCase();
            
            const dayMapping = {
                'mon': 'monday',
                'tue': 'tuesday', 
                'wed': 'wednesday',
                'thu': 'thursday',
                'fri': 'friday',
                'sat': 'saturday',
                'sun': 'sunday'
            };
            
            const currentDay = dayMapping[today] || 'monday';
            
            const option = select.querySelector(`option[value="${currentDay}"]`);
            if (option) {
                select.value = currentDay;
                option.textContent = option.textContent.replace(/^(\w+)/, '$1 (Today)');
            } else {
                select.value = select.options[0]?.value || 'monday';
            }
            
            updateWorkingHours();
        }

        function openProductModal(name, price, description) {
            const modal = document.getElementById('productModal');
            const content = document.getElementById('productModalContent');
            document.getElementById('modalProductName').textContent = name;
            document.getElementById('modalProductPrice').textContent = "GHS " + price;
            document.getElementById('modalProductDescription').textContent = description;

            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');
            setTimeout(() => content.classList.remove('translate-y-full'), 10);
        }

        function closeProductModal() {
            const modal = document.getElementById('productModal');
            const content = document.getElementById('productModalContent');
            content.classList.add('translate-y-full');
            setTimeout(() => {
                modal.classList.remove('opacity-100');
                modal.classList.add('opacity-0', 'pointer-events-none');
            }, 300);
        }

        // Schedule Flow Bottom Sheet Functions
        function openScheduleBottomSheet() {
            console.log('Opening schedule bottom sheet...');
            
            // Reset to first step
            currentStep = 1;
            
            const sheet = document.getElementById('scheduleFlowSheet');
            const content = document.getElementById('scheduleFlowContent');
            
            console.log('Sheet element:', sheet);
            console.log('Content element:', content);
            
            if (!sheet) {
                console.error('Schedule flow sheet not found!');
                return;
            }
            
            if (!content) {
                console.error('Schedule flow content not found!');
                return;
            }
            
            console.log('Adding active classes...');
            sheet.classList.add('active');
            content.classList.add('active');
            sheet.classList.remove('pointer-events-none');
            
            console.log('Classes added. Sheet classes:', sheet.className);
            console.log('Content classes:', content.className);
            
            // Load saved recipients
            loadSavedRecipients();
            
            // Initialize date input with minimum date (today + 2 hours)
            initializeDateInput();
            
            // Load user profile data
            loadUserProfileData();
            
            // Reset selected products
            selectedProducts = [];
            orderData.products = [];
            
            console.log('About to call goToStep...');
            goToStep('terms');
            console.log('goToStep completed');
        }

        function closeScheduleFlow() {
            const sheet = document.getElementById('scheduleFlowSheet');
            const content = document.getElementById('scheduleFlowContent');
            content.classList.remove('active');
            setTimeout(() => {
                sheet.classList.remove('active');
                sheet.classList.add('pointer-events-none');
            }, 300);
            
            // Reset step
            currentStep = 1;
            updateStepIndicators();
            
            // Reset data
            orderData = {
                recipient: {}
            };
            selectedPaymentMethod = null;
            userRating = 0;
            selectedProducts = [];
            hideError();
        }

        function goToStep(step) {
            console.log('goToStep called with:', step);
            
            // Hide all steps
            document.querySelectorAll('.step-content').forEach(el => {
                el.classList.add('hidden');
            });

            // Show current step
            const stepMap = {
                'terms': 'termsStep',
                'productSelection': 'productSelectionStep',
                'recipient': 'orderRecipientStep',
                'datetime': 'datetimeStep',
                'quantity': 'quantityStep',
                'review': 'orderReviewStep',
                'selectPayment': 'selectPaymentStep',
                'paymentDetails': 'paymentDetailsStep',
                'paymentProcessing': 'paymentProcessingStep',
                'paymentSuccess': 'paymentSuccessStep',
                'scheduleSent': 'scheduleSentStep',
                'ratingSuccess': 'ratingSuccessStep'
            };

            console.log('Step map:', stepMap);
            console.log('Looking for element ID:', stepMap[step]);

            const stepElement = document.getElementById(stepMap[step]);
            console.log('Found step element:', stepElement);
            
            if (stepElement) {
                stepElement.classList.remove('hidden');
                console.log('Removed hidden class from step element');

                // Special handling for specific steps
                if (step === 'productSelection') {
                    updateProductSelectionStep();
                } else if (step === 'recipient') {
                    updateRecipientStep();
                } else if (step === 'datetime') {
                    updateDateTimeStep();
                } else if (step === 'quantity') {
                    updateQuantityStep();
                } else if (step === 'review') {
                    updateOrderReview();
                } else if (step === 'paymentProcessing') {
                    startPaymentProcessing();
                } else if (step === 'paymentSuccess') {
                    showPaymentSuccess();
                } else if (step === 'scheduleSent') {
                    showScheduleSent();
                } else if (step === 'ratingSuccess') {
                    showRatingSuccess();
                }
            } else {
                console.error('Step element not found for:', step, 'ID:', stepMap[step]);
            }

            updateStepIndicators();
            updateNavigationButtons();
            hideError();
            console.log('goToStep completed');
        }

        function updateStepIndicators() {
            // Step indicators are hidden as requested
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const payBtn = document.getElementById('payBtn');
            const doneBtn = document.getElementById('doneBtn');

            // Show/hide previous button
            if (currentStep === 1) {
                prevBtn.classList.add('hidden');
            } else {
                prevBtn.classList.remove('hidden');
            }

            // Show/hide buttons based on current step
            nextBtn.classList.add('hidden');
            payBtn.classList.add('hidden');
            doneBtn.classList.add('hidden');

            if (currentStep === totalSteps) {
                doneBtn.classList.remove('hidden');
            } else if (currentStep === 8) { // Payment details step
                payBtn.classList.remove('hidden');
            } else if (currentStep < totalSteps) {
                nextBtn.classList.remove('hidden');

                // Update button text based on step
                if (currentStep === 6) { // Review step
                    nextBtn.textContent = 'Confirm Order';
                } else if (currentStep === 7) { // Select payment step
                    nextBtn.textContent = 'Proceed to Payment';
                } else if (currentStep === 2) { // Product selection step
                    nextBtn.textContent = selectedProducts.length > 0 ? 'Continue' : 'Skip for now';
                } else {
                    nextBtn.textContent = 'Continue';
                }
            }
        }

        function nextStep() {
            if (currentStep < totalSteps) {
                // Validate current step
                if (!validateCurrentStep()) {
                    return;
                }

                currentStep++;
                const steps = ['terms', 'productSelection', 'recipient', 'datetime', 'quantity', 'review', 'selectPayment', 'paymentDetails', 'paymentProcessing', 'paymentSuccess', 'scheduleSent', 'ratingSuccess'];
                if (currentStep <= steps.length && currentStep <= totalSteps) {
                    goToStep(steps[currentStep - 1]);
                }
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                const steps = ['terms', 'productSelection', 'recipient', 'datetime', 'quantity', 'review', 'selectPayment', 'paymentDetails', 'paymentProcessing', 'paymentSuccess', 'scheduleSent', 'ratingSuccess'];
                goToStep(steps[currentStep - 1]);
            }
        }

        function validateCurrentStep() {
            hideError();

            switch (currentStep) {
                case 1: // Terms - no validation needed
                    break;
                case 2: // Product Selection
                    // Allow user to continue even if no products selected
                    break;
                case 3: // Recipient
                    const address = document.getElementById('recipientAddress').value;

                    if (recipientType === 'business') {
                        const businessType = document.getElementById('businessType').value;
                        const businessName = document.getElementById('businessName').value;
                        if (!businessType) {
                            showError('Please select a business type');
                            return false;
                        }
                        if (!businessName) {
                            showError('Please enter a business name');
                            return false;
                        }

                        orderData.recipient.businessName = businessName;
                        orderData.recipient.businessType = businessType;
                    }

                    if (recipientType !== 'you') {
                        const name = document.getElementById('recipientName').value;
                        const phone = document.getElementById('recipientPhone').value;
                        const email = document.getElementById('recipientEmail').value;

                        if (!name || !phone || !email) {
                            showError('Please fill in all recipient information');
                            return false;
                        }

                        if (!/^0\d{9}$/.test(phone)) {
                            showError('Please enter a valid Ghanaian phone number (e.g., 0201234567)');
                            return false;
                        }

                        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                            showError('Please enter a valid email address');
                            return false;
                        }

                        orderData.recipient.name = name;
                        orderData.recipient.phone = phone;
                        orderData.recipient.email = email;
                    } else {
                        orderData.recipient.name = document.getElementById('youNameDisplay').textContent;
                        orderData.recipient.phone = document.getElementById('youPhoneDisplay').textContent;
                        orderData.recipient.email = document.getElementById('youEmailDisplay').textContent;
                    }

                    if (!address) {
                        showError('Please enter a delivery address');
                        return false;
                    }

                    orderData.recipient.address = address;
                    orderData.recipient.type = recipientType;

                    const saveToggle = document.getElementById('saveRecipientToggle').checked;
                    if (saveToggle && recipientType !== 'you') {
                        saveRecipient();
                    }
                    break;
                case 4: // Date and Time
                    selectedDate = document.getElementById('deliveryDate').value;
                    selectedTime = document.getElementById('deliveryTime').value;

                    if (!selectedDate || !selectedTime) {
                        showError('Please select both date and time for delivery');
                        return false;
                    }

                    const selectedDateTime = new Date(`${selectedDate} ${selectedTime}`);
                    const now = new Date();

                    if (selectedDateTime <= now) {
                        showError('Please select a future date and time for delivery');
                        return false;
                    }

                    orderData.deliveryDate = selectedDate;
                    orderData.deliveryTime = selectedTime;
                    break;
                case 5: // Quantity
                    if (selectedProducts.length === 0) {
                        showError('Please select at least one product');
                        return false;
                    }

                    const invalidProduct = selectedProducts.find(p => p.quantity < 1);
                    if (invalidProduct) {
                        showError('Product quantity must be at least 1');
                        return false;
                    }

                    orderData.products = selectedProducts;
                    orderData.deliveryInstructions = document.getElementById('deliveryInstructions').value;
                    break;
                case 7: // Select Payment
                    if (!selectedPaymentMethod) {
                        showError('Please select a payment method');
                        return false;
                    }
                    break;
                case 8: // Payment Details
                    if (!validatePaymentDetails()) {
                        return false;
                    }
                    break;
            }
            return true;
        }

        function validatePaymentDetails() {
            const mobileNetwork = document.getElementById('mobileNetwork').value;
            const mobileNumber = document.getElementById('mobileNumber').value;

            if (!mobileNetwork) {
                showError('Please select a mobile network');
                return false;
            }

            if (!mobileNumber) {
                showError('Please enter your mobile number');
                return false;
            }

            if (!/^0\d{9}$/.test(mobileNumber)) {
                showError('Please enter a valid Ghanaian phone number (e.g., 0201234567)');
                return false;
            }

            orderData.payment = {
                method: 'mobile',
                network: mobileNetwork,
                phoneNumber: mobileNumber
            };

            return true;
        }

        function initializeDateInput() {
            const dateInput = document.getElementById('deliveryDate');
            const now = new Date();
            const minDate = new Date(now.getTime() + 2 * 60 * 60 * 1000); // 2 hours from now

            const minDateString = minDate.toISOString().split('T')[0];
            dateInput.min = minDateString;

            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowString = tomorrow.toISOString().split('T')[0];
            dateInput.value = tomorrowString;
            selectedDate = tomorrowString;
        }

        function generateTimeSlots() {
            const timeSlotsGrid = document.getElementById('timeSlotsGrid');
            timeSlotsGrid.innerHTML = '';

            const timeSlots = [
                { time: '08:00', label: '8:00 AM', available: true },
                { time: '09:00', label: '9:00 AM', available: true },
                { time: '10:00', label: '10:00 AM', available: true },
                { time: '11:00', label: '11:00 AM', available: true },
                { time: '12:00', label: '12:00 PM', available: true },
                { time: '13:00', label: '1:00 PM', available: true },
                { time: '14:00', label: '2:00 PM', available: true },
                { time: '15:00', label: '3:00 PM', available: true },
                { time: '16:00', label: '4:00 PM', available: true },
                { time: '17:00', label: '5:00 PM', available: true },
                { time: '18:00', label: '6:00 PM', available: true }
            ];

            timeSlots.forEach(slot => {
                const timeSlotBtn = document.createElement('button');
                timeSlotBtn.type = 'button';
                timeSlotBtn.className = `time-slot-btn ${slot.available ? '' : 'disabled'}`;
                timeSlotBtn.textContent = slot.label;
                timeSlotBtn.disabled = !slot.available;

                if (slot.available) {
                    timeSlotBtn.onclick = () => selectTimeSlot(slot.time, slot.label, timeSlotBtn);
                }

                timeSlotsGrid.appendChild(timeSlotBtn);
            });
        }

        function selectTimeSlot(time, label, button) {
            document.querySelectorAll('.time-slot-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            button.classList.add('selected');
            document.getElementById('deliveryTime').value = time;
            selectedTime = time;
        }

        function selectTermsOption(type) {
            document.querySelectorAll('.terms-radio-item').forEach(item => {
                item.classList.remove('selected');
            });

            document.getElementById(`terms${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.add('selected');
            orderData.orderType = type;
        }

        function updateProductSelectionStep() {
            const productsGrid = document.getElementById('productsSelectionGrid');
            productsGrid.innerHTML = '';

            companyProducts.forEach(product => {
                const isSelected = selectedProducts.find(p => p.id === product.id);
                const productCard = document.createElement('div');
                productCard.className = `product-select-card ${isSelected ? 'selected' : ''}`;
                productCard.onclick = () => toggleProductSelection(product);

                productCard.innerHTML = `
                    <img src="${product.image}" alt="${product.name}" class="product-select-image">
                    <div class="product-select-name">${product.name}</div>
                    <div class="product-select-price">GHS ${product.price.toFixed(2)}</div>
                    ${isSelected ? `
                        <div class="product-select-quantity">
                            <button onclick="event.stopPropagation(); changeProductQuantityInSelection(${product.id}, -1)" class="quantity-btn-product">-</button>
                            <span class="quantity-display-product">${isSelected.quantity}</span>
                            <button onclick="event.stopPropagation(); changeProductQuantityInSelection(${product.id}, 1)" class="quantity-btn-product">+</button>
                        </div>
                    ` : ''}
                `;

                productsGrid.appendChild(productCard);
            });
        }

        function toggleProductSelection(product) {
            const existingIndex = selectedProducts.findIndex(p => p.id === product.id);
            
            if (existingIndex > -1) {
                // Remove product if already selected
                selectedProducts.splice(existingIndex, 1);
            } else {
                // Add product with default quantity of 1
                selectedProducts.push({
                    ...product,
                    quantity: 1
                });
            }
            
            updateProductSelectionStep();
        }

        function changeProductQuantityInSelection(productId, amount) {
            const productIndex = selectedProducts.findIndex(p => p.id === productId);
            
            if (productIndex > -1) {
                const product = selectedProducts[productIndex];
                const newQuantity = product.quantity + amount;
                
                if (newQuantity < 1) {
                    // Remove product if quantity becomes 0
                    selectedProducts.splice(productIndex, 1);
                } else if (newQuantity > 100) {
                    showError(`Maximum quantity per product is 100 items`);
                    return;
                } else {
                    selectedProducts[productIndex].quantity = newQuantity;
                }
                
                updateProductSelectionStep();
            }
        }

        function goToProductSelection() {
            currentStep = 2;
            goToStep('productSelection');
        }

        function selectRecipientType(type) {
            recipientType = type;

            document.querySelectorAll('.recipient-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(`recipient${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.add('active');

            const nameContainer = document.getElementById('recipientNameContainer');
            const phoneContainer = document.getElementById('recipientPhoneContainer');
            const emailContainer = document.getElementById('recipientEmailContainer');
            const businessTypeContainer = document.getElementById('businessTypeContainer');
            const businessNameContainer = document.getElementById('businessNameContainer');
            const youInfo = document.getElementById('youRecipientInfo');
            const savedContainer = document.getElementById('savedRecipientsContainer');

            if (type === 'you') {
                nameContainer.classList.add('hidden');
                phoneContainer.classList.add('hidden');
                emailContainer.classList.add('hidden');
                businessTypeContainer.classList.add('hidden');
                businessNameContainer.classList.add('hidden');
                youInfo.classList.remove('hidden');
                savedContainer.classList.add('hidden');
            } else {
                nameContainer.classList.remove('hidden');
                phoneContainer.classList.remove('hidden');
                emailContainer.classList.remove('hidden');
                youInfo.classList.add('hidden');

                if (type === 'business') {
                    businessTypeContainer.classList.remove('hidden');
                    businessNameContainer.classList.remove('hidden');
                } else {
                    businessTypeContainer.classList.add('hidden');
                    businessNameContainer.classList.add('hidden');
                }

                if (savedRecipients.length > 0) {
                    savedContainer.classList.remove('hidden');
                }
            }
        }

        function loadUserProfileData() {
            const userProfile = JSON.parse(localStorage.getItem('userProfile')) || {
                name: 'John Doe',
                phone1: '0241234567',
                email: 'john@example.com',
                address: '123 Main Street, Accra'
            };

            document.getElementById('youNameDisplay').textContent = userProfile.name || 'John Doe';
            document.getElementById('youPhoneDisplay').textContent = userProfile.phone1 || '0241234567';
            document.getElementById('youEmailDisplay').textContent = userProfile.email || 'john@example.com';
            document.getElementById('youAddressDisplay').textContent = userProfile.address || '123 Main Street, Accra';

            const addressField = document.getElementById('recipientAddress');
            if (addressField && userProfile.address) {
                addressField.value = userProfile.address;
            }
        }

        function saveUserAddress() {
            const address = document.getElementById('recipientAddress').value;
            if (address && recipientType === 'you') {
                const userProfile = JSON.parse(localStorage.getItem('userProfile')) || {};
                userProfile.address = address;
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
                document.getElementById('youAddressDisplay').textContent = address;
            }
        }

        function loadSavedRecipients() {
            const savedRecipientsData = localStorage.getItem('savedRecipients');
            if (savedRecipientsData) {
                savedRecipients = JSON.parse(savedRecipientsData);
            } else {
                savedRecipients = [
                    {
                        id: 1,
                        name: 'Jane Smith',
                        phone: '0241234567',
                        email: 'jane@example.com',
                        address: '123 Main St, Accra',
                        type: 'individual'
                    },
                    {
                        id: 2,
                        name: 'ABC Corporation',
                        phone: '0209876543',
                        email: 'info@abccorp.com',
                        address: '456 Business Ave, Tema',
                        type: 'business',
                        businessName: 'ABC Corporation',
                        businessType: 'office'
                    }
                ];
                localStorage.setItem('savedRecipients', JSON.stringify(savedRecipients));
            }

            updateSavedRecipientsList();
        }

        function updateSavedRecipientsList() {
            const savedList = document.getElementById('savedRecipientsList');
            savedList.innerHTML = '';

            if (savedRecipients.length === 0) {
                savedList.innerHTML = '<p class="text-gray-400 text-center py-4">No saved recipients yet</p>';
                return;
            }

            savedRecipients.forEach(recipient => {
                const recipientItem = document.createElement('div');
                recipientItem.className = 'saved-recipient-item';
                recipientItem.style.position = 'relative';

                recipientItem.innerHTML = `
                    <button onclick="deleteSavedRecipient(${recipient.id})" class="delete-recipient-btn" title="Delete recipient">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18"/>
                            <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2 2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                            <path d="M10 11v6"/>
                            <path d="M14 11v6"/>
                        </svg>
                    </button>
                    <div onclick="selectSavedRecipient(${recipient.id})" class="recipient-content">
                        <div class="saved-recipient-name">${recipient.name}</div>
                        <div class="saved-recipient-info">${recipient.phone}  ${recipient.address}</div>
                    </div>
                `;

                savedList.appendChild(recipientItem);
            });
        }

        function selectSavedRecipient(recipientId) {
            const recipient = savedRecipients.find(r => r.id === recipientId);
            if (!recipient) return;

            selectedSavedRecipient = recipient;
            event.currentTarget.closest('.saved-recipient-item').classList.add('selected');

            document.getElementById('recipientName').value = recipient.name;
            document.getElementById('recipientPhone').value = recipient.phone;
            document.getElementById('recipientEmail').value = recipient.email;
            document.getElementById('recipientAddress').value = recipient.address;

            if (recipient.type === 'business') {
                document.getElementById('businessType').value = recipient.businessType;
                document.getElementById('businessName').value = recipient.businessName;
            }

            selectRecipientType(recipient.type);
        }

        function deleteSavedRecipient(recipientId) {
            if (confirm('Are you sure you want to delete this saved recipient?')) {
                savedRecipients = savedRecipients.filter(r => r.id !== recipientId);
                localStorage.setItem('savedRecipients', JSON.stringify(savedRecipients));
                updateSavedRecipientsList();
                showSuccess('Recipient deleted successfully');

                if (selectedSavedRecipient && selectedSavedRecipient.id === recipientId) {
                    selectedSavedRecipient = null;
                }
            }
            event.stopPropagation();
        }

        function saveRecipient() {
            const name = document.getElementById('recipientName').value;
            const phone = document.getElementById('recipientPhone').value;
            const email = document.getElementById('recipientEmail').value;
            const address = document.getElementById('recipientAddress').value;

            const newRecipient = {
                id: Date.now(),
                name,
                phone,
                email,
                address,
                type: recipientType
            };

            if (recipientType === 'business') {
                newRecipient.businessName = document.getElementById('businessName').value;
                newRecipient.businessType = document.getElementById('businessType').value;
            }

            const existingIndex = savedRecipients.findIndex(r =>
                r.name === name && r.phone === phone && r.email === email
            );

            if (existingIndex === -1) {
                savedRecipients.push(newRecipient);
                localStorage.setItem('savedRecipients', JSON.stringify(savedRecipients));
                updateSavedRecipientsList();
                showSuccess('Recipient saved successfully');
            }
        }

        function updateDateTimeStep() {
            generateTimeSlots();

            if (orderData.deliveryDate) {
                document.getElementById('deliveryDate').value = orderData.deliveryDate;
            }

            if (orderData.deliveryTime) {
                document.getElementById('deliveryTime').value = orderData.deliveryTime;

                const timeSlots = document.querySelectorAll('.time-slot-btn');
                timeSlots.forEach(btn => {
                    btn.classList.remove('selected');
                    if (btn.textContent.includes(orderData.deliveryTime.replace(':00', ''))) {
                        btn.classList.add('selected');
                    }
                });
            }
        }

        function updateRecipientStep() {
            if (orderData.recipient) {
                if (recipientType !== 'you') {
                    document.getElementById('recipientName').value = orderData.recipient.name || '';
                    document.getElementById('businessName').value = orderData.recipient.businessName || '';
                    document.getElementById('recipientPhone').value = orderData.recipient.phone || '';
                    document.getElementById('recipientEmail').value = orderData.recipient.email || '';
                    document.getElementById('recipientAddress').value = orderData.recipient.address || '';

                    if (orderData.recipient.type === 'business' && orderData.recipient.businessType) {
                        document.getElementById('businessType').value = orderData.recipient.businessType;
                    }
                } else {
                    document.getElementById('recipientAddress').value = orderData.recipient.address || '';
                }
            }
        }

        function updateQuantityStep() {
            const selectedContainer = document.getElementById('selectedProductsContainer');
            selectedContainer.innerHTML = '';

            if (selectedProducts.length > 0) {
                selectedProducts.forEach((product, index) => {
                    const selectedItem = document.createElement('div');
                    selectedItem.className = 'selected-product-item';
                    selectedItem.innerHTML = `
                        <img src="${product.image}" alt="${product.name}" class="selected-product-image">
                        <div class="selected-product-details">
                            <div class="selected-product-name">${product.name}</div>
                            <div class="selected-product-price">GHS ${product.price.toFixed(2)} each</div>
                        </div>
                        <div class="selected-product-quantity">
                            <button onclick="changeProductQuantity(${index}, -1)" class="quantity-btn-small">-</button>
                            <span class="quantity-display-small">${product.quantity}</span>
                            <button onclick="changeProductQuantity(${index}, 1)" class="quantity-btn-small">+</button>
                        </div>
                    `;
                    selectedContainer.appendChild(selectedItem);
                });
            } else {
                const noProducts = document.createElement('div');
                noProducts.className = 'no-products-selected';
                noProducts.textContent = 'No products selected. Please go back and select products.';
                selectedContainer.appendChild(noProducts);
            }

            updateQuantityCalculations();
        }

        function changeProductQuantity(productIndex, amount) {
            if (selectedProducts[productIndex]) {
                const product = selectedProducts[productIndex];
                const newQuantity = product.quantity + amount;

                if (newQuantity < 1) {
                    showError(`Minimum quantity is 1 item`);
                    return;
                }

                if (newQuantity > 100) {
                    showError(`Maximum quantity per product is 100 items`);
                    return;
                }

                selectedProducts[productIndex].quantity = newQuantity;
                updateQuantityStep();
            }
        }

        function updateQuantityCalculations() {
            calculateTotals();
            
            document.getElementById('quantitySubtotal').textContent = `GHS ${orderData.subtotal.toFixed(2)}`;
            document.getElementById('serviceFeeDisplay').textContent = `GHS ${orderData.serviceFee.toFixed(2)}`;
            document.getElementById('quantityTotal').textContent = `GHS ${orderData.total.toFixed(2)}`;
        }

        function calculateTotals() {
            orderData.subtotal = selectedProducts.reduce((sum, product) => 
                sum + (product.price * product.quantity), 0);
            const totalItems = selectedProducts.reduce((sum, product) => sum + product.quantity, 0);
            orderData.serviceFee = totalItems * SERVICE_FEE_PER_ITEM;
            orderData.total = orderData.subtotal + orderData.serviceFee;
        }

        function updateOrderReview() {
            if (selectedProducts.length === 0) return;

            calculateTotals();

            const productsList = document.getElementById('reviewProductsList');
            productsList.innerHTML = '';

            selectedProducts.forEach(product => {
                const productItem = document.createElement('div');
                productItem.className = 'review-product-item';
                productItem.innerHTML = `
                    <img src="${product.image}" alt="${product.name}" class="review-product-image">
                    <div class="review-product-details">
                        <div class="review-product-name">${product.quantity}x ${product.name}</div>
                        <div class="review-product-price">GHS ${(product.price * product.quantity).toFixed(2)}</div>
                    </div>
                `;
                productsList.appendChild(productItem);
            });

            document.getElementById('reviewDeliveryDate').textContent = formatDate(selectedDate);
            document.getElementById('reviewDeliveryTime').textContent = formatTime(selectedTime);
            document.getElementById('reviewDeliveryAddress').textContent = orderData.recipient.address || '';

            const instructions = document.getElementById('deliveryInstructions').value || 'None provided';
            document.getElementById('reviewDeliveryInstructions').textContent = instructions;

            document.getElementById('reviewSubtotal').textContent = `GHS ${orderData.subtotal.toFixed(2)}`;
            document.getElementById('reviewServiceFee').textContent = `GHS ${orderData.serviceFee.toFixed(2)}`;
            document.getElementById('reviewTotal').textContent = `GHS ${orderData.total.toFixed(2)}`;

            orderData.products = selectedProducts;
            orderData.deliveryInstructions = instructions;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatTime(timeString) {
            const [hours, minutes] = timeString.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}:${minutes} ${ampm}`;
        }

        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;

            document.querySelectorAll('.payment-method-card').forEach(card => {
                card.classList.remove('selected');
            });

            event.currentTarget.classList.add('selected');
        }

        function processPayment() {
            if (!validateCurrentStep()) {
                return;
            }
            nextStep();
        }

        function startPaymentProcessing() {
            let progress = 0;
            const progressBar = document.getElementById('paymentProgressBar');

            const interval = setInterval(() => {
                progress += 10;
                progressBar.style.width = progress + '%';

                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        nextStep();
                    }, 1000);
                }
            }, 300);
        }

        function showPaymentSuccess() {
            const transactionId = 'TXN' + Date.now().toString().slice(-8);
            document.getElementById('transactionIdDisplay').textContent = transactionId;
            document.getElementById('amountPaidDisplay').textContent = `GHS ${orderData.total.toFixed(2)}`;

            orderData.transactionId = transactionId;
            orderData.timestamp = new Date().toISOString();
        }

        function showScheduleSent() {
            const orderId = 'ORD' + Date.now().toString().slice(-8);
            document.getElementById('orderIdDisplay').textContent = orderId;
            document.getElementById('orderDateDisplay').textContent = formatDate(selectedDate);
            document.getElementById('orderTimeDisplay').textContent = formatTime(selectedTime);

            const totalItems = selectedProducts.reduce((sum, product) => sum + product.quantity, 0);
            document.getElementById('orderItemsDisplay').textContent = `${totalItems} items`;

            orderData.orderId = orderId;
            orderData.orderDate = formatDate(selectedDate);
            orderData.orderTime = formatTime(selectedTime);
        }

        function setRating(rating) {
            userRating = rating;

            document.querySelectorAll('.rating-star-large').forEach((star, index) => {
                star.textContent = '';
                star.classList.remove('selected');

                if (index < rating) {
                    star.textContent = '';
                    star.classList.add('selected');
                }
            });
        }

        async function submitRating() {
            const comment = document.getElementById('ratingComment').value;

            if (userRating === 0) {
                showError('Please select a rating');
                return;
            }

            orderData.rating = userRating;
            orderData.comment = comment;

            // Prefer server-side API to ensure DB save without client auth
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const branchId = urlParams.get('branch_id');
                const branchData = window.currentCompany && window.currentCompany.branch_id ? window.currentCompany : null;
                const resolvedBranchId = branchData?.branch_id || branchId;
                const resolvedCompanyId = branchData?.company_id || (window.currentCompany?.company_id || '');

                const payload = {
                    company_id: resolvedCompanyId,
                    branch_id: resolvedBranchId || '',
                    stars: userRating,
                    comment: comment || '',
                    product_tags: (typeof selectedTags !== 'undefined') ? Array.from(selectedTags) : [],
                    location: orderData.recipient?.address || (window.currentCompany?.location || ''),
                    order_id: orderData.orderId || null,
                    customer_id: null
                };

                const resp = await fetch('/api/ratings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!resp.ok) throw new Error('Server API failed');

                const data = await resp.json();
                console.log(' Rating saved via server API', data);

                // Also reflect immediately in local histogram & list
                const storageKey = `reviews_${resolvedCompanyId || 'unknown'}_${resolvedBranchId || 'all'}`;
                const existing = localStorage.getItem(storageKey);
                const reviewsLocal = existing ? JSON.parse(existing) : [];
                const newReview = {
                    id: Date.now(),
                    name: 'You',
                    rating: userRating,
                    comment: comment || '',
                    tags: (typeof selectedTags !== 'undefined') ? Array.from(selectedTags) : [],
                    date: new Date().toISOString()
                };
                reviewsLocal.push(newReview);
                localStorage.setItem(storageKey, JSON.stringify(reviewsLocal));

                updateRatingDisplay();
                renderReviews();

                currentStep = 12;
                goToStep('ratingSuccess');
                return;
            } catch (apiErr) {
                console.warn('API rating save failed, attempting Appwrite client save...', apiErr);
            }

            // Save rating to Appwrite DB (client-side) as secondary path
            try {
                if (window.databases && window.appwriteConfig && window.account) {
                    const user = await window.account.get();
                    const ratingId = (Math.random().toString(36).slice(2, 10) + Date.now().toString(36)).slice(0, 20);

                    // Resolve company and branch IDs
                    const urlParams = new URLSearchParams(window.location.search);
                    const branchId = urlParams.get('branch_id');
                    const branchData = window.currentCompany && window.currentCompany.branch_id ? window.currentCompany : null;
                    const resolvedBranchId = branchData?.branch_id || branchId;
                    const resolvedCompanyId = branchData?.company_id || (window.currentCompany?.company_id || '');

                    const payload = {
                        rating_id: ratingId,
                        company_id: resolvedCompanyId,
                        branch_id: resolvedBranchId || '',
                        order_id: orderData.orderId || null,
                        customer_id: user.$id,
                        stars: userRating,
                        comment: comment || '',
                        created_at: new Date().toISOString(),
                        location: orderData.recipient?.address || (window.currentCompany?.location || ''),
                        product_tags: (typeof selectedTags !== 'undefined') ? Array.from(selectedTags) : []
                    };

                    await window.databases.createDocument(
                        window.appwriteConfig.DATABASE_ID,
                        window.appwriteConfig.RATINGS_TABLE,
                        window.ID.unique(),
                        payload
                    );
                    console.log(' Rating saved to Appwrite', payload);

                    // Refresh ratings and histogram after successful save
                    const storageKey = `reviews_${resolvedCompanyId || 'unknown'}_${resolvedBranchId || 'all'}`;
                    const existing = localStorage.getItem(storageKey);
                    const reviewsLocal = existing ? JSON.parse(existing) : [];
                    const newReview = {
                        id: Date.now(),
                        name: 'You',
                        rating: userRating,
                        comment: comment || '',
                        tags: (typeof selectedTags !== 'undefined') ? Array.from(selectedTags) : [],
                        date: new Date().toISOString()
                    };
                    reviewsLocal.push(newReview);
                    localStorage.setItem(storageKey, JSON.stringify(reviewsLocal));

                    updateRatingDisplay();
                    renderReviews();

                    // Proceed to success only after saving
                    currentStep = 12;
                    goToStep('ratingSuccess');
                    return;
                } else {
                    console.error(' Appwrite not available for ratings');
                }
            } catch (err) {
                console.error(' Failed to save rating via Appwrite client:', err);
            }

            // Fallback: save locally and update UI
            const urlParams = new URLSearchParams(window.location.search);
            const branchId = urlParams.get('branch_id');
            const branchData = window.currentCompany && window.currentCompany.branch_id ? window.currentCompany : null;
            const resolvedBranchId = branchData?.branch_id || branchId;
            const resolvedCompanyId = branchData?.company_id || (window.currentCompany?.company_id || '');
            const localReview = {
                id: (Math.random().toString(36).slice(2, 10) + Date.now().toString(36)).slice(0, 20),
                name: 'Anonymous',
                rating: userRating,
                comment: comment || '',
                tags: (typeof selectedTags !== 'undefined') ? Array.from(selectedTags) : [],
                date: new Date()
            };
            reviews.push(localReview);
            const storageKey = `reviews_${resolvedCompanyId || 'unknown'}_${resolvedBranchId || 'all'}`;
            localStorage.setItem(storageKey, JSON.stringify(reviews));
            updateRatingDisplay();
            renderReviews();
            currentStep = 12;
            goToStep('ratingSuccess');
        }

        function showRatingSuccess() {
            document.getElementById('finalOrderId').textContent = orderData.orderId;
            document.getElementById('finalDeliveryDate').textContent = `${formatDate(selectedDate)} at ${formatTime(selectedTime)}`;
            document.getElementById('finalTotalPaid').textContent = `GHS ${orderData.total.toFixed(2)}`;

            let stars = '';
            for (let i = 0; i < 5; i++) {
                if (i < userRating) {
                    stars += '';
                } else {
                    stars += '';
                }
            }
            document.getElementById('finalRatingStars').textContent = stars;
        }

        function finishFlow() {
            completeOrderFlow();
        }

        function completeOrderFlow() {
            saveOrderToHistory();
            
            showSuccess(`Thank you for your order! Order ID: ${orderData.orderId}. Your order has been confirmed and will be processed.`);

            setTimeout(() => {
                closeScheduleFlow();
            }, 3000);
        }

        function saveOrderToHistory() {
            try {
                let existingOrders = localStorage.getItem('phluowiseOrders');
                let orders = existingOrders ? JSON.parse(existingOrders) : [];

                const formattedDate = formatDate(selectedDate);
                const formattedTime = formatTime(selectedTime);

                const newOrder = {
                    orderId: orderData.orderId,
                    company: currentCompany.name,
                    location: orderData.recipient ? orderData.recipient.address : 'Accra, Ghana',
                    payment: 'Mobile Money',
                    time: formattedTime,
                    date: formattedDate,
                    price: `GH${orderData.total.toFixed(2)}`,
                    status: 'pending',
                    statusText: 'Pending',
                    statusColor: '#F2A78C',
                    products: orderData.products,
                    subtotal: orderData.subtotal,
                    serviceFee: orderData.serviceFee,
                    total: orderData.total,
                    recipient: orderData.recipient,
                    paymentDetails: orderData.payment,
                    timestamp: new Date().toISOString(),
                    rating: orderData.rating,
                    comment: orderData.comment,
                    transactionId: orderData.transactionId,
                    deliveryInstructions: orderData.deliveryInstructions,
                    deliveryDate: selectedDate,
                    deliveryTime: selectedTime
                };

                orders.unshift(newOrder);
                localStorage.setItem('phluowiseOrders', JSON.stringify(orders));

            } catch (error) {
                console.error('Error saving order to history:', error);
                showError('Error saving order. Please try again.');
            }
        }

        function downloadOrderPDF() {
            try {
                const orderId = document.getElementById('orderIdDisplay')?.textContent || 'N/A';
                const orderDate = document.getElementById('orderDateDisplay')?.textContent || 'N/A';
                const orderTime = document.getElementById('orderTimeDisplay')?.textContent || 'N/A';
                const orderItems = document.getElementById('orderItemsDisplay')?.textContent || 'N/A';
                
                const recipientName = orderData.recipient?.name || 'N/A';
                const recipientPhone = orderData.recipient?.phone || 'N/A';
                const recipientAddress = orderData.recipient?.address || 'N/A';
                const deliveryInstructions = orderData.recipient?.instructions || 'None';
                
                let subtotal = 0;
                let totalItems = 0;
                let productsList = [];
                
                if (selectedProducts && selectedProducts.length > 0) {
                    selectedProducts.forEach(product => {
                        const productPrice = parseFloat(product.price) || 0;
                        const productQuantity = parseInt(product.quantity) || 0;
                        const productTotal = productPrice * productQuantity;
                        
                        subtotal += productTotal;
                        totalItems += productQuantity;
                        productsList.push({
                            name: product.name || 'Unknown Product',
                            quantity: productQuantity,
                            price: productPrice,
                            total: productTotal
                        });
                    });
                }
                
                const serviceFee = totalItems * SERVICE_FEE_PER_ITEM;
                const totalAmount = subtotal + serviceFee;

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 15;
                const contentWidth = pageWidth - (margin * 2);
                let yPosition = 15;
                
                function checkPageBreak(requiredHeight) {
                    if (yPosition + requiredHeight > pageHeight - 20) {
                        doc.addPage();
                        yPosition = 15;
                        return true;
                    }
                    return false;
                }
                
                doc.setFillColor(59, 116, 255);
                doc.rect(0, 0, pageWidth, 50, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text('Phluowise', margin, 25);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text('Order Confirmation', margin, 35);
                
                doc.setFontSize(10);
                doc.text(`#${orderId}`, pageWidth - margin, 25, { align: 'right' });
                
                doc.setTextColor(0, 0, 0);
                yPosition = 60;
                
                doc.setFontSize(9);
                doc.setTextColor(100, 100, 100);
                doc.text(`Generated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, margin, yPosition);
                yPosition += 15;
                
                checkPageBreak(40);
                
                doc.setTextColor(59, 116, 255);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Delivery Information', margin, yPosition);
                yPosition += 8;
                
                doc.setDrawColor(59, 116, 255);
                doc.setLineWidth(0.5);
                doc.line(margin, yPosition, margin + 60, yPosition);
                yPosition += 12;
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                
                doc.text('Date:', margin, yPosition);
                doc.setFont('helvetica', 'bold');
                doc.text(orderDate, margin + 25, yPosition);
                
                doc.setFont('helvetica', 'normal');
                doc.text('Time:', margin + 80, yPosition);
                doc.setFont('helvetica', 'bold');
                doc.text(orderTime, margin + 100, yPosition);
                yPosition += 10;
                
                doc.setFont('helvetica', 'normal');
                doc.text('Items:', margin, yPosition);
                doc.setFont('helvetica', 'bold');
                doc.text(orderItems, margin + 25, yPosition);
                
                doc.setFont('helvetica', 'normal');
                doc.text('Status:', margin + 80, yPosition);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(16, 185, 129);
                doc.text('Confirmed', margin + 100, yPosition);
                doc.setTextColor(0, 0, 0);
                yPosition += 20;
                
                checkPageBreak(60);
                
                doc.setTextColor(59, 116, 255);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Customer Information', margin, yPosition);
                yPosition += 8;
                
                doc.setDrawColor(59, 116, 255);
                doc.line(margin, yPosition, margin + 80, yPosition);
                yPosition += 12;
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                
                doc.text('Name:', margin, yPosition);
                doc.setFont('helvetica', 'bold');
                doc.text(recipientName.substring(0, 40), margin + 25, yPosition);
                yPosition += 10;
                
                doc.setFont('helvetica', 'normal');
                doc.text('Phone:', margin, yPosition);
                doc.setFont('helvetica', 'bold');
                doc.text(recipientPhone, margin + 25, yPosition);
                yPosition += 10;
                
                doc.setFont('helvetica', 'normal');
                doc.text('Address:', margin, yPosition);
                
                const addressLines = doc.splitTextToSize(recipientAddress, contentWidth - 25);
                doc.setFont('helvetica', 'bold');
                addressLines.forEach((line, index) => {
                    if (index === 0) {
                        doc.text(line, margin + 25, yPosition);
                    } else {
                        doc.text(line, margin, yPosition + (index * 7));
                    }
                });
                yPosition += (addressLines.length * 7) + 5;
                
                if (deliveryInstructions && deliveryInstructions !== 'None') {
                    doc.setFont('helvetica', 'normal');
                    doc.text('Instructions:', margin, yPosition);
                    
                    const instructionLines = doc.splitTextToSize(deliveryInstructions, contentWidth - 25);
                    doc.setFont('helvetica', 'bold');
                    instructionLines.forEach((line, index) => {
                        if (index === 0) {
                            doc.text(line, margin + 25, yPosition);
                        } else {
                            doc.text(line, margin, yPosition + (index * 7));
                        }
                    });
                    yPosition += (instructionLines.length * 7) + 5;
                }
                
                checkPageBreak(80);
                
                doc.setTextColor(59, 116, 255);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Order Details', margin, yPosition);
                yPosition += 8;
                
                doc.setDrawColor(59, 116, 255);
                doc.line(margin, yPosition, margin + 60, yPosition);
                yPosition += 12;
                
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, yPosition - 7, contentWidth, 12, 'F');
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text('Product', margin + 3, yPosition);
                doc.text('Qty', margin + 80, yPosition);
                doc.text('Price', margin + 100, yPosition);
                doc.text('Total', margin + 140, yPosition);
                yPosition += 15;
                
                doc.setFont('helvetica', 'normal');
                productsList.forEach((product, index) => {
                    checkPageBreak(12);
                    
                    if (index % 2 === 0) {
                        doc.setFillColor(248, 248, 248);
                        doc.rect(margin, yPosition - 7, contentWidth, 10, 'F');
                    }
                    
                    const productName = product.name.substring(0, 25);
                    const quantity = product.quantity.toString();
                    const unitPrice = `GHS ${product.price.toFixed(2)}`;
                    const totalPrice = `GHS ${product.total.toFixed(2)}`;
                    
                    doc.text(productName, margin + 3, yPosition);
                    doc.text(quantity, margin + 80, yPosition);
                    doc.text(unitPrice, margin + 100, yPosition);
                    doc.text(totalPrice, margin + 140, yPosition);
                    yPosition += 10;
                });
                
                yPosition += 10;
                
                checkPageBreak(50);
                
                doc.setFillColor(240, 248, 255);
                doc.rect(margin, yPosition - 5, contentWidth, 45, 'F');
                doc.setDrawColor(59, 116, 255);
                doc.rect(margin, yPosition - 5, contentWidth, 45);
                
                doc.setTextColor(59, 116, 255);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('Price Summary', margin + 3, yPosition + 5);
                yPosition += 15;
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Subtotal:', margin + 3, yPosition);
                doc.setFont('helvetica', 'bold');
                doc.text(`GHS ${subtotal.toFixed(2)}`, margin + 120, yPosition);
                yPosition += 8;
                
                doc.setFont('helvetica', 'normal');
                doc.text(`Service Fee (${totalItems} items):`, margin + 3, yPosition);
                doc.setFont('helvetica', 'bold');
                doc.text(`GHS ${serviceFee.toFixed(2)}`, margin + 120, yPosition);
                yPosition += 10;
                
                doc.setDrawColor(59, 116, 255);
                doc.line(margin + 3, yPosition, margin + contentWidth - 3, yPosition);
                yPosition += 8;
                
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('Total Amount:', margin + 3, yPosition);
                doc.setTextColor(59, 116, 255);
                doc.text(`GHS ${totalAmount.toFixed(2)}`, margin + 120, yPosition);
                
                yPosition = pageHeight - 25;
                doc.setTextColor(100, 100, 100);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text('Thank you for choosing Phluowise!', margin, yPosition);
                doc.text('This is an automatically generated order confirmation.', margin, yPosition + 6);
                doc.text('For inquiries, contact our customer support.', margin, yPosition + 12);
                
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.text(`Page ${i} of ${totalPages}`, pageWidth - margin, yPosition + 12, { align: 'right' });
                }
                
                // Mobile-optimized PDF save with fallback
                if (isAPKEnvironment()) {
                    // APK environment - use specialized methods
                    tryAPKPDFDownload(doc, `order_${orderId}_${Date.now()}.pdf`).then(() => {
                        showMobileNotification('PDF processing for APK environment...', 'success');
                    }).catch(() => {
                        // Fallback to mobile methods
                        tryMobilePDFDownload(doc, `order_${orderId}_${Date.now()}.pdf`).then(() => {
                            showMobileNotification('PDF download initiated! Check downloads or open in new tab.', 'success');
                        }).catch(() => {
                            doc.save(`order_${orderId}_${Date.now()}.pdf`);
                            showMobileNotification('PDF download initiated! Check downloads folder.', 'success');
                        });
                    });
                } else if (isMobileDevice()) {
                    // Regular mobile browser
                    tryMobilePDFDownload(doc, `order_${orderId}_${Date.now()}.pdf`).then(() => {
                        showMobileNotification('PDF download initiated! Check downloads or open in new tab.', 'success');
                    }).catch(() => {
                        // Fallback to standard download
                        doc.save(`order_${orderId}_${Date.now()}.pdf`);
                        showMobileNotification('PDF download initiated! Check downloads folder.', 'success');
                    });
                } else {
                    // Standard desktop download
                    doc.save(`order_${orderId}_${Date.now()}.pdf`);
                }
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showMobileNotification('Failed to generate PDF. Please try again.', 'error');
            }
        }

        // Mobile device detection with APK detection
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   (window.innerWidth <= 768 && 'ontouchstart' in window);
        }
        
        // APK detection (Android app environment)
        function isAPKEnvironment() {
            // More aggressive APK detection
            const isAndroidApp = navigator.userAgent.includes('Android') && 
                               !navigator.userAgent.includes('Mobile Safari') &&
                               !navigator.userAgent.includes('Chrome');
            
            const hasCordova = window.cordova || window.PhoneGap || window.phonegap;
            const isWebView = navigator.userAgent.includes('wv');
            
            // Website 2 APK Pro specific detection
            const isWebsite2APK = navigator.userAgent.includes('wv') || 
                                 window.location.protocol === 'file:' ||
                                 (window.webkit && window.webkit.messageHandlers);
            
            return isAndroidApp || hasCordova || isWebView || isWebsite2APK;
        }
        
        // WebView APK detection (Website 2 APK Pro)
        function isWebViewAPK() {
            return navigator.userAgent.includes('wv') || 
                   window.location.protocol === 'file:' ||
                   (window.webkit && window.webkit.messageHandlers);
        }
        
        // APK-specific PDF download methods
        async function tryAPKPDFDownload(doc, filename) {
            return new Promise((resolve, reject) => {
                try {
                    // Method 1: Try WebView APK specific method (Website 2 APK Pro)
                    if (isWebViewAPK()) {
                        tryWebViewAPKSave(doc, filename).then(resolve).catch(() => {
                            // Fallback to other methods
                            tryDirectAndroidSave(doc, filename).then(resolve).catch(() => {
                                // Method 2: Try Cordova File Plugin if available
                                if (window.cordova && window.cordova.file) {
                                    tryCordovaFileSave(doc, filename).then(resolve).catch(() => {
                                        // Method 3: WebView download with share intent
                                        tryWebViewDownload(doc, filename).then(resolve).catch(reject);
                                    });
                                } else {
                                    // Method 3: WebView download with share intent
                                    tryWebViewDownload(doc, filename).then(resolve).catch(reject);
                                }
                            });
                        });
                    } else {
                        // Method 2: Try direct Android file system access
                        tryDirectAndroidSave(doc, filename).then(resolve).catch(() => {
                            // Method 3: Try Cordova File Plugin if available
                            if (window.cordova && window.cordova.file) {
                                tryCordovaFileSave(doc, filename).then(resolve).catch(() => {
                                    // Method 4: WebView download with share intent
                                    tryWebViewDownload(doc, filename).then(resolve).catch(reject);
                                });
                            } else {
                                // Method 4: WebView download with share intent
                                tryWebViewDownload(doc, filename).then(resolve).catch(reject);
                            }
                        });
                    }
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        // WebView APK specific save method (Website 2 APK Pro)
        async function tryWebViewAPKSave(doc, filename) {
            return new Promise((resolve, reject) => {
                try {
                    // Method 1: Try to open with Android native PDF viewer
                    const pdfBlob = doc.output('blob');
                    const dataUrl = doc.output('datauristring');
                    
                    // Create a download link that triggers Android system PDF viewer
                    const downloadLink = document.createElement('a');
                    downloadLink.href = dataUrl;
                    downloadLink.download = filename;
                    downloadLink.style.display = 'none';
                    
                    // Force Android to open with system PDF app
                    downloadLink.setAttribute('download', filename);
                    downloadLink.setAttribute('target', '_system'); // Try system viewer
                    downloadLink.setAttribute('rel', 'noopener noreferrer');
                    
                    document.body.appendChild(downloadLink);
                    
                    // Method 1: Try to trigger Android system PDF viewer
                    try {
                        downloadLink.click();
                        showMobileNotification('Opening PDF with Android PDF viewer...', 'success');
                        
                        // Check if PDF opened in new window (system viewer)
                        setTimeout(() => {
                            const newWindow = window.open(dataUrl, '_system', 'width=800,height=600');
                            if (newWindow) {
                                showMobileNotification('PDF opened with system viewer. Use Android share/save options.', 'success');
                            } else {
                                // Fallback to direct download
                                tryDirectAndroidPDFOpen(doc, filename).then(resolve).catch(reject);
                            }
                            resolve();
                        }, 1000);
                        
                    } catch (e1) {
                        try {
                            // Method 2: Try system viewer with different approach
                            downloadLink.setAttribute('target', '_blank');
                            downloadLink.click();
                            showMobileNotification('Opening PDF with Android system app...', 'success');
                            resolve();
                        } catch (e2) {
                            try {
                                // Method 3: Try to open with Android intent
                                const event = document.createEvent('MouseEvents');
                                event.initEvent('click', true, true);
                                downloadLink.dispatchEvent(event);
                                showMobileNotification('Opening PDF with Android PDF viewer...', 'success');
                                resolve();
                            } catch (e3) {
                                console.log('System viewer methods failed, trying direct open:', e3);
                                // Method 4: Direct Android PDF open
                                tryDirectAndroidPDFOpen(doc, filename).then(resolve).catch(reject);
                            }
                        }
                    }
                    
                } catch (error) {
                    console.log('WebView APK save failed:', error);
                    reject(error);
                }
            });
        }
        
        // Direct Android PDF open method
        async function tryDirectAndroidPDFOpen(doc, filename) {
            return new Promise((resolve, reject) => {
                try {
                    const dataUrl = doc.output('datauristring');
                    
                    // Try to open with Android system PDF viewer
                    const pdfWindow = window.open(dataUrl, '_system', 'noopener,noreferrer');
                    
                    if (pdfWindow) {
                        showMobileNotification('PDF opened with Android system viewer!', 'success');
                        resolve();
                    } else {
                        // Fallback: Create download link for manual opening
                        const downloadLink = document.createElement('a');
                        downloadLink.href = dataUrl;
                        downloadLink.download = filename;
                        downloadLink.style.display = 'none';
                        downloadLink.target = '_blank';
                        
                        document.body.appendChild(downloadLink);
                        downloadLink.click();
                        document.body.removeChild(downloadLink);
                        
                        showMobileNotification('PDF ready. Open with Android PDF viewer from downloads.', 'info');
                        resolve();
                    }
                    
                } catch (error) {
                    console.log('Direct Android PDF open failed:', error);
                    reject(error);
                }
            });
        }
        
        // Enhanced Cordova file save method
        async function tryCordovaFileSave(doc, filename) {
            return new Promise((resolve, reject) => {
                try {
                    const pdfBlob = doc.output('blob');
                    
                    // Try multiple Android storage locations
                    const storageLocations = [
                        window.cordova.file.externalRootDirectory,  // External storage (SD card)
                        window.cordova.file.dataDirectory,        // Internal app storage
                        window.cordova.file.cacheDirectory,       // App cache
                        window.cordova.file.syncedDataDirectory   // Synced storage
                    ];
                    
                    let locationIndex = 0;
                    
                    function tryNextLocation() {
                        if (locationIndex >= storageLocations.length) {
                            reject(new Error('All storage locations failed'));
                            return;
                        }
                        
                        const storage = storageLocations[locationIndex];
                        const locationName = locationIndex === 0 ? 'External Storage' : 
                                         locationIndex === 1 ? 'App Storage' :
                                         locationIndex === 2 ? 'App Cache' : 'Synced Storage';
                        
                        try {
                            storage.getDirectory('Download', {
                                create: true,
                                exclusive: false
                            }, function(dirEntry) {
                                dirEntry.getFile(filename, {
                                    create: true,
                                    exclusive: false
                                }, function(fileEntry) {
                                    fileEntry.createWriter(function(fileWriter) {
                                        fileWriter.write(pdfBlob);
                                        fileWriter.onwriteend = function() {
                                            showMobileNotification(`PDF saved to ${locationName}  Downloads folder!`, 'success');
                                            resolve();
                                        };
                                        fileWriter.onerror = function() {
                                            console.log(`Failed to write to ${locationName}, trying next location...`);
                                            locationIndex++;
                                            tryNextLocation();
                                        };
                                    }, function() {
                                        console.log(`Failed to create file in ${locationName}, trying next location...`);
                                        locationIndex++;
                                        tryNextLocation();
                                    });
                                }, function() {
                                    console.log(`Failed to access Downloads in ${locationName}, trying next location...`);
                                    locationIndex++;
                                    tryNextLocation();
                                });
                            }, function() {
                                console.log(`Failed to access ${locationName}, trying next location...`);
                                locationIndex++;
                                tryNextLocation();
                            });
                        } catch (error) {
                            console.log(`Error accessing ${locationName}:`, error);
                            locationIndex++;
                            tryNextLocation();
                        }
                    }
                    
                    tryNextLocation();
                    
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        // WebView download with share intent
        async function tryWebViewDownload(doc, filename) {
            return new Promise((resolve, reject) => {
                try {
                    // Method 1: Data URL with share intent
                    const dataUrl = doc.output('datauristring');
                    
                    // Create share link
                    const shareLink = document.createElement('a');
                    shareLink.href = dataUrl;
                    shareLink.download = filename;
                    shareLink.style.display = 'none';
                    shareLink.target = '_blank';
                    
                    // Try to trigger Android share/download
                    document.body.appendChild(shareLink);
                    shareLink.click();
                    document.body.removeChild(shareLink);
                    
                    // Method 2: Open in new tab for manual save
                    setTimeout(() => {
                        const newTab = window.open(dataUrl, '_blank');
                        if (newTab) {
                            showMobileNotification('PDF opened. Use browser menu to save/share.', 'info');
                        } else {
                            showMobileNotification('PDF ready. Check app downloads or use share menu.', 'info');
                        }
                        resolve();
                    }, 1000);
                    
                } catch (error) {
                    reject(error);
                }
            });
        }
        async function tryMobilePDFDownload(doc, filename) {
            return new Promise((resolve, reject) => {
                try {
                    // Method 1: Try standard download first
                    doc.save(filename);
                    
                    // Method 2: Create blob and download link (fallback)
                    setTimeout(() => {
                        try {
                            const pdfBlob = doc.output('blob');
                            const url = URL.createObjectURL(pdfBlob);
                            const downloadLink = document.createElement('a');
                            downloadLink.href = url;
                            downloadLink.download = filename;
                            downloadLink.style.display = 'none';
                            document.body.appendChild(downloadLink);
                            downloadLink.click();
                            document.body.removeChild(downloadLink);
                            URL.revokeObjectURL(url);
                            
                            // Method 3: Open in new tab as additional fallback
                            setTimeout(() => {
                                try {
                                    const newTab = window.open(url, '_blank');
                                    if (newTab) {
                                        newTab.focus();
                                        showMobileNotification('PDF opened in new tab. Save from browser menu.', 'info');
                                    }
                                } catch (tabError) {
                                    console.log('Could not open in new tab:', tabError);
                                }
                            }, 500);
                            
                            resolve();
                        } catch (fallbackError) {
                            console.log('Blob method failed, trying data URL:', fallbackError);
                            
                            // Method 4: Data URL fallback
                            try {
                                const dataUrl = doc.output('datauristring');
                                const dataLink = document.createElement('a');
                                dataLink.href = dataUrl;
                                dataLink.download = filename;
                                dataLink.style.display = 'none';
                                dataLink.target = '_blank'; // Force new window
                                document.body.appendChild(dataLink);
                                dataLink.click();
                                document.body.removeChild(dataLink);
                                
                                showMobileNotification('PDF download initiated. Check your downloads or browser tabs.', 'info');
                                resolve();
                            } catch (dataUrlError) {
                                console.log('Data URL method failed:', dataUrlError);
                                reject(dataUrlError);
                            }
                        }
                    }, 1000);
                    
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        // Mobile notification system
        function showMobileNotification(message, type = 'info') {
            // Remove existing notifications
            const existingNotification = document.querySelector('.mobile-notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `mobile-notification fixed top-4 left-4 right-4 z-50 p-4 rounded-lg backdrop-blur-xl border transition-all duration-300 transform translate-y-[-100px]`;
            
            // Style based on type
            if (type === 'error') {
                notification.className += ' bg-red-500/20 border-red-500/40 text-red-300';
            } else if (type === 'success') {
                notification.className += ' bg-green-500/20 border-green-500/40 text-green-300';
            } else {
                notification.className += ' bg-blue-500/20 border-blue-500/40 text-blue-300';
            }
            
            // Add Android-specific guidance
            const androidGuidance = isAPKEnvironment() ? 
                '<div class="mt-2 text-xs opacity-75"> Check Android notification panel for download progress</div>' : 
                isMobileDevice() ? 
                '<div class="mt-2 text-xs opacity-75"> Check browser downloads and notifications</div>' : 
                '';
            
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="flex-shrink-0">
                        ${type === 'error' ? '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>' : 
                          type === 'success' ? '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>' :
                          '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'}
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium">${message}</p>
                        ${androidGuidance}
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="flex-shrink-0 p-1 hover:bg-white/10 rounded">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-y-[-100px]');
                notification.classList.add('translate-y-0');
            }, 100);
            
            // Auto-remove after 8 seconds (longer for Android guidance)
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.add('translate-y-[-100px]');
                    setTimeout(() => notification.remove(), 300);
                }
            }, 8000);
        }
        
        // Android notification panel checker
        function checkAndroidNotificationPanel() {
            if (isAPKEnvironment()) {
                showMobileNotification(' Check your Android notification panel (pull down from top) for download progress!', 'info');
                
                // Try to trigger Android notification if possible
                if (window.cordova && window.cordova.plugins && window.cordova.plugins.notification) {
                    try {
                        window.cordova.plugins.notification.local.schedule({
                            id: 1,
                            title: "PDF Download",
                            message: "Your PDF is being downloaded...",
                            sound: "file://sounds/notification.mp3"
                        });
                    } catch (e) {
                        console.log('Could not trigger Android notification:', e);
                    }
                }
            }
        }

        // Message display functions
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('active');

            setTimeout(() => {
                errorDiv.classList.remove('active');
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.classList.add('active');

            setTimeout(() => {
                successDiv.classList.remove('active');
            }, 5000);
        }

        function hideError() {
            document.getElementById('errorMessage').classList.remove('active');
        }

        // Original functions from schedule.html
        function showSocialModal(platform) {
            const modal = document.getElementById('socialModal');
            const platformNameSpan = document.getElementById('socialPlatformName');
            
            platformNameSpan.textContent = platform;
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.style.opacity = '1';
            }, 10);
        }

        function closeSocialModal() {
            const modal = document.getElementById('socialModal');
            
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function toggleContactPopup() {
            const popup = document.getElementById('contactPopup');
            popup.classList.toggle('hidden');
        }

        function toggleTag(btn) {
            const tagText = btn.textContent.trim();
            
            if (selectedTags.has(tagText)) {
                selectedTags.delete(tagText);
                btn.style.backgroundColor = '#40444B';
                btn.style.borderColor = 'transparent';
            } else {
                selectedTags.add(tagText);
                btn.style.backgroundColor = 'var(--btn-color)';
                btn.style.borderColor = 'var(--btn-border)';
            }
        }

        function submitReview() {
            const commentInput = document.querySelector('#view-rating input[type="text"]');
            const comment = commentInput.value.trim();

            if (currentRating === 0) {
                alert('Please select a star rating');
                return;
            }

            if (!comment) {
                alert('Please write a review');
                return;
            }

            const newReview = {
                id: Date.now(),
                name: 'You',
                rating: currentRating,
                comment: comment,
                tags: Array.from(selectedTags),
                date: new Date()
            };

            reviews.push(newReview);
            saveReviews();

            updateRatingDisplay();
            renderReviews();

            currentRating = 0;
            selectedTags.clear();
            commentInput.value = '';
            updateStarDisplay();
            
            document.querySelectorAll('#ratingPopup button').forEach(btn => {
                if (btn.textContent.includes('Sachets') || btn.textContent.includes('Bottle') || btn.textContent.includes('Dispenser')) {
                    btn.style.backgroundColor = '#40444B';
                    btn.style.borderColor = 'transparent';
                }
            });

            toggleRatingPopup();

            alert('Thank you for your review!');
        }

        async function loadReviews() {
            const urlParams = new URLSearchParams(window.location.search);
            const branchId = urlParams.get('branch_id');
            const branchData = window.currentCompany && window.currentCompany.branch_id ? window.currentCompany : null;
            const resolvedBranchId = branchData?.branch_id || branchId;
            const resolvedCompanyId = branchData?.company_id || (window.currentCompany?.company_id || '');

            try {
                if (window.databases && window.appwriteConfig && window.Query) {
                    const queries = [window.Query.equal('company_id', resolvedCompanyId)];
                    if (resolvedBranchId) queries.push(window.Query.equal('branch_id', resolvedBranchId));
                    const result = await window.databases.listDocuments(
                        window.appwriteConfig.DATABASE_ID,
                        window.appwriteConfig.RATINGS_TABLE,
                        queries
                    );
                    reviews = (result.documents || []).map(doc => ({
                        id: doc.$id || doc.rating_id,
                        name: 'Anonymous',
                        rating: doc.stars,
                        comment: doc.comment || '',
                        tags: Array.isArray(doc.product_tags) ? doc.product_tags : [],
                        date: doc.created_at ? new Date(doc.created_at) : (doc.$createdAt ? new Date(doc.$createdAt) : new Date())
                    }));
                    return;
                }
            } catch (e) {
                console.error('Failed to load ratings from Appwrite, falling back to localStorage', e);
            }

            const storageKey = `reviews_${resolvedCompanyId || 'unknown'}_${resolvedBranchId || 'all'}`;
            const savedReviews = localStorage.getItem(storageKey);
            if (savedReviews) {
                const parsed = JSON.parse(savedReviews);
                reviews = parsed.map(review => ({
                    ...review,
                    date: review.date ? new Date(review.date) : new Date()
                }));
            } else {
                reviews = [];
            }
        }

        function saveReviews() {
            const urlParams = new URLSearchParams(window.location.search);
            const branchId = urlParams.get('branch_id');
            const branchData = window.currentCompany && window.currentCompany.branch_id ? window.currentCompany : null;
            const resolvedBranchId = branchData?.branch_id || branchId;
            const resolvedCompanyId = branchData?.company_id || (window.currentCompany?.company_id || '');
            const storageKey = `reviews_${resolvedCompanyId || 'unknown'}_${resolvedBranchId || 'all'}`;
            localStorage.setItem(storageKey, JSON.stringify(reviews));
        }

        function calculateRatingStats() {
            if (reviews.length === 0) {
                return { average: 0, total: 0, distribution: [0, 0, 0, 0, 0] };
            }

            const total = reviews.reduce((sum, review) => sum + review.rating, 0);
            const average = (total / reviews.length).toFixed(1);
            
            const distribution = [0, 0, 0, 0, 0];
            reviews.forEach(review => {
                distribution[review.rating - 1]++;
            });

            const percentages = distribution.map(count => 
                reviews.length > 0 ? Math.round((count / reviews.length) * 100) : 0
            );

            return { average, total: reviews.length, distribution: percentages };
        }

        function updateRatingDisplay() {
            const stats = calculateRatingStats();
            
            const ratingView = document.getElementById('view-rating');
            if (!ratingView) return;
            ratingView.querySelector('.text-white.font-bold.text-xl').textContent = `${stats.average} rating`;
            ratingView.querySelector('.text-white.font-semibold.text-lg').textContent = `${stats.total} reviews`;

            const ratingBarsContainer = ratingView.querySelector('.mt-4.flex.flex-col.gap-2');
            const barRows = ratingBarsContainer ? ratingBarsContainer.querySelectorAll(':scope > .flex.flex-row.items-center.gap-2') : [];

            const starLabels = [5, 4, 3, 2, 1];
            starLabels.forEach((star, index) => {
                // Correct mapping: 1-star -> index 0, ..., 5-star -> index 4
                const percentage = stats.distribution[star - 1];
                const row = barRows[index];
                if (row) {
                    const bar = row.querySelector('.bg-white.h-full');
                    const percentageText = row.querySelector('.text-white.font-medium.text-lg');
                    if (bar) bar.style.width = `${percentage}%`;
                    if (percentageText) percentageText.textContent = `${percentage}%`;
                }
            });
        }

        // Initialize ratings view
        loadReviews().then(() => {
            updateRatingDisplay();
            renderReviews();
        });

        function renderReviews() {
            const container = document.querySelector('#view-rating .flex.flex-col.gap-4');
            if (!container) return;

            container.innerHTML = '';
            
            reviews.slice().reverse().forEach(review => {
                const reviewElement = document.createElement('div');
                reviewElement.className = 'flex flex-col gap-4';
                
                const stars = ''.repeat(review.rating) + ''.repeat(5 - review.rating);
                const dateStr = review.date && typeof review.date.toLocaleDateString === 'function' 
                    ? review.date.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric', 
                        year: 'numeric' 
                    })
                    : 'Unknown date';
                
                reviewElement.innerHTML = `
                    <div class="flex flex-row gap-4">
                        <div class="rounded-full border"
                            style="height: 63px; width: 63px; background-color: #292B2F99; border-color: #DADADA;">
                            <div class="w-full h-full rounded-full flex items-center justify-center text-white text-xl font-bold">
                                ${review.name.charAt(0).toUpperCase()}
                            </div>
                        </div>
                        <div class="flex flex-col justify-between py-1">
                            <span class="text-white font-medium text-lg pl-8">${review.name}</span>
                            <div class="flex flex-row gap-2">
                                <div class="flex flex-row gap-1">
                                    <span class="text-white text-base">${stars}</span>
                                </div>
                                <span class="text-white font-medium text-lg">${dateStr}</span>
                            </div>
                        </div>
                    </div>
                    <div class="w-full rounded-[12px] p-2"
                        style="height: 90px; background-color: #292B2FCC;">
                        <p class="text-white px-5 py-2 text-lg font-normal">
                            ${review.comment}
                        </p>
                    </div>
                    ${review.tags && review.tags.length > 0 ? `
                        <div class="flex flex-row gap-2">
                            ${review.tags.map(tag => `
                                <span class="px-3 py-1 rounded-full text-sm font-medium" 
                                      style="background-color: #40444B; color: white;">
                                    ${tag}
                                </span>
                            `).join('')}
                        </div>
                    ` : ''}
                `;
                
                container.appendChild(reviewElement);
            });
        }

        function setStarRating(rating) {
            currentRating = rating;
            updateStarDisplay();
        }

        function updateStarDisplay() {
            const stars = document.querySelectorAll('#ratingPopup .star-rating-btn svg path');
            stars.forEach((star, index) => {
                if (index < currentRating) {
                    star.setAttribute('fill', 'gold');
                } else {
                    star.setAttribute('fill', '#666');
                }
            });
        }

        function toggleRatingPopup() {
            const popup = document.getElementById('ratingPopup');
            popup.classList.toggle('hidden');
        }

        // Map Functions
        function initMap() {
            map = L.map('scheduleMap', {
                zoomControl: false,
                attributionControl: false
            }).setView([currentCompany.coordinates.lat, currentCompany.coordinates.lng], 14);

            currentTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: ' OpenStreetMap contributors, CARTO',
                maxZoom: 19
            }).addTo(map);

            const companyIcon = L.divIcon({
                className: 'custom-marker',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });

            companyMarker = L.marker([currentCompany.coordinates.lat, currentCompany.coordinates.lng], {
                icon: companyIcon
            }).addTo(map);

            companyMarker.bindPopup(`
                <div class="p-2">
                    <h3 class="font-semibold text-white mb-1">${currentCompany.name}<span class="material-symbols-outlined verified-checkmark" style="font-size: 16px; margin-left: 2px;">verified</span></h3>
                    <p class="text-gray-300 text-sm mb-2">${currentCompany.location}</p>
                    <button onclick="callCompany()" class="text-[#3B74FF] text-sm hover:underline">Call Now</button>
                </div>
            `);

            function getUserLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };

                            const userIcon = L.divIcon({
                                className: 'user-location-marker',
                                iconSize: [16, 16],
                                iconAnchor: [8, 8]
                            });

                            userMarker = L.marker([userLocation.lat, userLocation.lng], {
                                icon: userIcon
                            }).addTo(map);

                            userMarker.bindPopup(`
                                <div class="p-2">
                                    <h3 class="font-semibold text-white mb-1">Your Location</h3>
                                    <p class="text-gray-300 text-sm">Current position</p>
                                </div>
                            `);
                        },
                        (error) => {
                            // console.log('Location access denied');
                        }
                    );
                }
            }

            getUserLocation();
        }

        function zoomInMap() {
            if (map) map.zoomIn();
        }

        function zoomOutMap() {
            if (map) map.zoomOut();
        }

        function callCompany() {
            if (currentCompany.phone) {
                window.location.href = `tel:${currentCompany.phone}`;
            }
        }

        function toggleMapType() {
            if (!map || !currentTileLayer) return;
            
            map.removeLayer(currentTileLayer);
            
            isSatelliteView = !isSatelliteView;
            
            if (isSatelliteView) {
                currentTileLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: ' Esri',
                    maxZoom: 19
                });
            } else {
                currentTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: ' OpenStreetMap contributors,  CARTO',
                    maxZoom: 19
                });
            }
            
            currentTileLayer.addTo(map);
        }

        function openTermsOfService() {
            document.getElementById('termsModal').classList.remove('hidden');
        }

        function closeTermsModal() {
            document.getElementById('termsModal').classList.add('hidden');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.classList.remove('dark-theme', 'gray-theme', 'light-theme');
            document.body.classList.add(savedTheme + '-theme');

            setSubView('schedule');
            
            loadReviews();
            updateRatingDisplay();
            renderReviews();
            
            setCurrentDay();
            
            setTimeout(() => {
                initMap();
            }, 100);

            selectRecipientType('you');
            
            selectTermsOption('schedule');
            
            const addressField = document.getElementById('recipientAddress');
            if (addressField) {
                addressField.addEventListener('input', saveUserAddress);
            }
            
            loadUserProfileData();
            
            // Add mobile touch support for Schedule Pickup button
            const schedulePickupBtn = document.getElementById('schedulePickupBtn');
            if (schedulePickupBtn) {
                // Handle both click and touch events
                schedulePickupBtn.addEventListener('click', openScheduleBottomSheet);
                schedulePickupBtn.addEventListener('touchstart', function(e) {
                    e.preventDefault(); // Prevent default touch behavior
                    openScheduleBottomSheet();
                }, { passive: false });
                
                console.log('Schedule Pickup button event listeners added');
            }
        });
    </script>
    <script>
        // Branch data fetching for schedule.html
        async function fetchBranchDataForSchedule() {
            try {
                // Get branch_id from URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                let branchId = urlParams.get('branch_id');
                
                if (!branchId) {
                    console.warn('No branch_id found in URL parameters');
                    return;
                }
                
                console.log(' Fetching branch data for branch_id:', branchId);
                
                // Force refresh to get fresh data from database (bypass cache)
                console.log(' Forcing data refresh from database...');
                const companyData = await window.companyDataManager.refreshCompanyData();
                
                console.log(' Searching for branch_id:', branchId);
                console.log(' Data type of branchId:', typeof branchId);
                console.log(' Length of branchId:', branchId.length);
                
                let branchData = null;
                
                // Try multiple search approaches
                for (let i = 0; i < companyData.length; i++) {
                    const branch = companyData[i];
                    console.log(` Checking branch ${i + 1}:`);
                    console.log(`  - branch_id: "${branch.branch_id}" (type: ${typeof branch.branch_id}, length: ${branch.branch_id.length})`);
                    console.log(`  - branch_name: "${branch.branch_name}"`);
                    
                    // Try exact match
                    if (branch.branch_id === branchId) {
                        branchData = branch;
                        console.log(' Found exact match!');
                        break;
                    }
                    
                    // Try string conversion match (in case of type issues)
                    if (String(branch.branch_id) === String(branchId)) {
                        branchData = branch;
                        console.log(' Found string conversion match!');
                        break;
                    }
                }
                
                // If not found, try to auto-correct common wrong IDs
                if (!branchData) {
                    console.log(' Branch not found, attempting auto-correction...');
                    
                    // Map of common wrong IDs to correct ones
                    const idCorrections = {
                        '68b8cb454e339050f5b0': '68b8cb42defcefb9507b', // One piece
                        '694c82027fceaf9bd962': '694c82005940d48eecae', // YAQSON HQ
                    };
                    
                    if (idCorrections[branchId]) {
                        const correctId = idCorrections[branchId];
                        console.log(` Auto-correcting ID: ${branchId}  ${correctId}`);
                        
                        // Update URL without page reload
                        const newUrl = `${window.location.pathname}?branch_id=${correctId}`;
                        window.history.replaceState({}, '', newUrl);
                        
                        // Search again with correct ID
                        for (let i = 0; i < companyData.length; i++) {
                            const branch = companyData[i];
                            if (branch.branch_id === correctId) {
                                branchData = branch;
                                console.log(' Found branch after auto-correction!');
                                break;
                            }
                        }
                    }
                }
                
                if (!branchData) {
                    console.error(' Branch not found with branch_id:', branchId);
                    console.log(' Available branch IDs:');
                    companyData.forEach((branch, index) => {
                        console.log(`  ${index + 1}. branch_id: "${branch.branch_id}" - branch_name: "${branch.branch_name}"`);
                    });
                    return;
                }
                
                console.log(' Found branch data:', branchData);
                
                // Update HTML elements with branch data
                await updateBranchDataInHTML(branchData);
                
            } catch (error) {
                console.error(' Error fetching branch data:', error);
            }
        }
        
        async function updateBranchDataInHTML(branchData) {
            // 1. Update header image for banner
            const bannerImage = document.querySelector('.absolute.inset-0.w-full.h-\\[180px\\].overflow-hidden img');
            if (bannerImage && branchData.header_image) {
                bannerImage.src = branchData.header_image;
                console.log(' Updated banner image:', branchData.header_image);
            }
            
            // 2. Update profile image
            const profileImage = document.getElementById('shopProfileImage');
            if (profileImage && branchData.profile_image) {
                profileImage.src = branchData.profile_image;
                console.log(' Updated profile image:', branchData.profile_image);
            }
            
            // 3. Update company name and location
            const companyNameElement = document.querySelector('h1.text-white.text-2xl.font-bold');
            if (companyNameElement && branchData.branch_name) {
                companyNameElement.textContent = branchData.branch_name;
                console.log(' Updated company name:', branchData.branch_name);
            }
            
            const locationElement = document.querySelector('p.text-\\[\\#808080\\].text-lg.mt-1');
            if (locationElement && branchData.location) {
                locationElement.textContent = branchData.location;
                console.log(' Updated location:', branchData.location);
            }
            
            // 4. Update description with email
            const descriptionText = document.getElementById('descriptionText');
            if (descriptionText) {
                // Combine description and email with || separator
                let descriptionContent = branchData.description || 'No description available';
                if (branchData.email) {
                    descriptionContent += ` || ${branchData.email}`;
                }
                descriptionText.textContent = descriptionContent;
                console.log(' Updated description with email');
            }
            
            // 5. Update read more text if needed
            const readMoreText = document.getElementById('readMoreText');
            if (readMoreText && branchData.description) {
                // Adjust read more text based on description length
                const isLongDescription = branchData.description.length > 100;
                readMoreText.textContent = isLongDescription ? 'Read less' : 'Read more';
            }
            
            // 6. Update social media links
            await updateSocialMediaLinks(branchData);
            
            // 7. Update working days and hours
            updateWorkingDaysFromDB(branchData);
        }
        
        // Update social media links - fetch from social_media collection
        async function updateSocialMediaLinks(branchData) {
            console.log(' Checking social media fields in branchData:', branchData);
            
            try {
                // Fetch social media data from social_media collection for this branch
                const socialMediaQuery = [
                    window.Query.equal('branch_id', branchData.branch_id)
                ];
                
                const socialMediaResponse = await window.databases.listDocuments(
                    window.appwriteConfig.DATABASE_ID,
                    'social_media',
                    socialMediaQuery
                );
                
                console.log(' Social media data from social_media collection:', socialMediaResponse.documents);
                
                if (socialMediaResponse.documents.length > 0) {
                    const socialData = socialMediaResponse.documents[0];
                    
                    const socialPlatforms = {
                        'Facebook': socialData.facebook || socialData.facebook_url || '',
                        'Instagram': socialData.instagram || socialData.instagram_url || '',
                        'Twitter': socialData.twitter || socialData.twitter_url || '',
                        'LinkedIn': socialData.linkedin || socialData.linkedin_url || '',
                        'Discord': socialData.discord || socialData.discord_url || ''
                    };
                    
                    console.log(' Social media URLs found:', socialPlatforms);
                    
                    // Update each social media icon click handler
                    Object.keys(socialPlatforms).forEach(platform => {
                        const socialUrl = socialPlatforms[platform];
                        
                        // Create new click handler function
                        const newHandler = socialUrl ? 
                            `window.open('${socialUrl}', '_blank')` : 
                            `showSocialModal('${platform}')`;
                        
                        // Update onclick attribute for all social media icons
                        const socialIcons = document.querySelectorAll(`div[onclick*="${platform}"]`);
                        socialIcons.forEach(icon => {
                            icon.setAttribute('onclick', newHandler);
                        });
                        
                        console.log(` Updated ${platform}: ${socialUrl ? 'Link available - ' + socialUrl : 'Show empty modal'}`);
                    });
                } else {
                    console.log(' No social media data found for this branch');
                    // Show empty modal for all platforms
                    ['Facebook', 'Instagram', 'Twitter', 'LinkedIn', 'Discord'].forEach(platform => {
                        const socialIcons = document.querySelectorAll(`div[onclick*="${platform}"]`);
                        socialIcons.forEach(icon => {
                            icon.setAttribute('onclick', `showSocialModal('${platform}')`);
                        });
                    });
                }
            } catch (error) {
                console.error(' Error fetching social media data:', error);
            }
        }
        
        // Update working days from database
        function updateWorkingDaysFromDB(branchData) {
            console.log(' Working days data from branchData:', branchData.working_days);
            console.log(' Raw working days data:', JSON.stringify(branchData.working_days, null, 2));
            
            // Get working days data from branchData - it should be an array from the database
            let workingDays = {};
            
            if (branchData.working_days && Array.isArray(branchData.working_days)) {
                // Convert array format to object format for easier access
                workingDays = {};
                branchData.working_days.forEach((day, index) => {
                    console.log(` Processing day ${index}:`, day);
                    
                    if (day.day && day.time) {
                        console.log(` Day ${day.day} has time: ${day.time}`);
                        
                        // Parse time format like "8:00 AM - 6:00 PM"
                        const timeMatch = day.time.match(/(\d{1,2}:\d{2}\s*[AP]M)\s*-\s*(\d{1,2}:\d{2}\s*[AP]M)/i);
                        if (timeMatch) {
                            const dayKey = day.day.toLowerCase();
                            workingDays[dayKey] = {
                                open: timeMatch[1],
                                close: timeMatch[2],
                                isOpen: true,
                                originalTime: day.time // Keep original for debugging
                            };
                            console.log(` Successfully parsed ${day.day}: ${timeMatch[1]} - ${timeMatch[2]}`);
                        } else {
                            // Try other formats like "8:00 - 18:00"
                            const simpleTimeMatch = day.time.match(/(\d{1,2}:\d{2})\s*-\s*(\d{1,2}:\d{2})/);
                            if (simpleTimeMatch) {
                                const dayKey = day.day.toLowerCase();
                                workingDays[dayKey] = {
                                    open: simpleTimeMatch[1],
                                    close: simpleTimeMatch[2],
                                    isOpen: true,
                                    originalTime: day.time
                                };
                                console.log(` Successfully parsed ${day.day} (simple format): ${simpleTimeMatch[1]} - ${simpleTimeMatch[2]}`);
                            } else {
                                console.log(` Failed to parse time for ${day.day}: "${day.time}"`);
                            }
                        }
                    } else {
                        console.log(` Day ${index} missing day or time field:`, day);
                    }
                });
            } else if (branchData.workingHours) {
                workingDays = branchData.workingHours;
                console.log(' Using workingHours from branchData');
            } else if (typeof branchData.working_days === 'object') {
                workingDays = branchData.working_days;
                console.log(' Using working_days as object');
            }
            
            console.log(' Processed working days:', workingDays);
            console.log(' Final working days JSON:', JSON.stringify(workingDays, null, 2));
            
            // Update the currentCompany object with new working hours
            if (window.currentCompany) {
                window.currentCompany.workingHours = workingDays;
                console.log(' Updated window.currentCompany.workingHours');
            }
            
            // Update the working days select and display (only call once)
            updateWorkingHours();
            
            // Only set current day once to prevent duplication
            if (!window.currentDaySet) {
                setCurrentDay();
                window.currentDaySet = true;
            }
            
            console.log(' Updated working days from database:', workingDays);
        }
        
        // Initialize branch data fetching when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Clear any cached company data to force fresh fetch
            if (window.companyDataManager) {
                window.companyDataManager.lastFetchTime = null;
                window.companyDataManager.companies = [];
                window.companyDataManager.branches = [];
                window.companyDataManager.workingDays = [];
            }
            
            // Clear any localStorage cache
            localStorage.removeItem('companyDataCache');
            localStorage.removeItem('branchesCache');
            
            // Wait a bit for company data manager to be ready
            setTimeout(() => {
                fetchBranchDataForSchedule();
            }, 1500); // Increased delay to ensure everything is loaded
        });
    </script>
    <script src="js/notifications.js"></script>
</body>

</html>
